<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BTYX Join</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" xintegrity="sha512-BNaRQnYJYiPSqHHDb58B0yaPfCu+Wgds8Gp/gU33kqBtgNS4tSPHuGibyoVBL5gI9kLmbG0CzdlIQHNi1HTY1g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <style>
        :root { --bty-blue: #000C53; --bty-yellow: #FFE200; --bty-red: #EC3237; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bty-blue); color: #f0f0f0; }
        .action-option { transition: background-color 0.2s, transform 0.2s; }
        .action-option:hover { background-color: rgba(255, 226, 0, 0.2); transform: scale(1.02); }
        .action-option:active { transform: scale(0.98); }
        .action-option:disabled { opacity: 0.5; cursor: not-allowed; transform: none !important; background-color: #2d3748 !important; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        #memento-card {
             background-color: #0f172a; /* Slate 900 */
             background-image: 
                radial-gradient(circle at 100% 0%, rgba(255, 226, 0, 0.05) 0%, transparent 40%),
                radial-gradient(circle at 0% 100%, rgba(0, 12, 83, 0.4) 0%, transparent 50%);
        }
        .mirror-content { background: rgba(30, 41, 59, 0.8); border: 1px solid rgba(255,255,255,0.1); border-radius: 1rem; padding: 1.5rem; text-align: center; }
    </style>
</head>
<body class="antialiased text-white">

    <div id="app" class="min-h-screen flex flex-col items-center justify-center p-4 pb-12">
        <!-- Content dynamically populated by JavaScript -->
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, doc, setDoc, serverTimestamp, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        const firebaseConfig = { apiKey: "AIzaSyBjHO57QKoMW-u4oLGGdgDSqw5gttqX6Fg", authDomain: "btyx-61dc6.firebaseapp.com", projectId: "btyx-61dc6", storageBucket: "btyx-61dc6.appspot.com", messagingSenderId: "851137405745", appId: "1:851137405745:web:c95b86b6f0462a9bc20610" };
        let app, db, auth;
        try { app = initializeApp(firebaseConfig); db = getFirestore(app); auth = getAuth(app); await signInAnonymously(auth); listenToSessionState(); } catch (e) { console.error("Firebase init failed:", e); renderError("Connection Error", "Could not connect. Please try again."); }
        
        const appContainer = document.getElementById('app');
        let userData = JSON.parse(localStorage.getItem('btyxUserData_v4_final')) || {};
        let currentQuestionIndex = 0;
        const quizChoices = [];

        const archetypes = {
            "The Innovator": { color: "#f59e0b", quote: "Machine Learning opened my eyes to what's possible. Now I use data to build solutions for real problems.", description: "You are driven by technology, using data and problem-solving to build new and better ways to do things." , recommendations: ["A.I. @ South Korea", "Engineering @ Rockwell Automation"]},
            "The Global Explorer": { color: "#10b981", quote: "Studying abroad taught me that leadership transcends borders. Every culture has wisdom to share.", description: "You have a deep cultural curiosity and a desire to understand the world through international exchange." , recommendations: ["Leadership @ New Zealand", "Social Sciences @ Mihara, Japan"]},
            "The Industry Trailblazer": { color: "#3b82f6", quote: "My industry attachment showed me engineering isn't just theory - it's changing lives every day.", description: "You are focused on practical application and making a real-world impact through hands-on industry experience.", recommendations: ["Mechatronics @ ITE West & Makita", "Maritime Sustainability @ PIL"] },
            "The Community Steward": { color: "#ef4444", quote: "D.R.E.A.M. isn't just our values - it's how we lift each other up. That's true leadership.", description: "You are motivated by community service, mentorship, and empowering others to achieve their best.", recommendations: ["Leading school initiatives", "Mentoring junior students"] },
            "The Creative Artist": { color: "#ec4899", quote: "Through school concerts, I learned my voice matters. Art changes hearts.", description: "You find energy in performance, artistic expression, and bringing creative visions to life.", recommendations: ["Geography/Literature @ Bali", "School concert performances"] },
            "The STEM Futurist": { color: "#8b5cf6", quote: "Science isn't about memorizing facts - it's the thrill of discovery, of using data to prove the impossible possible.", description: "You thrive on research, data analysis, and systematic investigation to solve complex problems and shape the future.", recommendations: ["Research @ A*STAR", "Cybersecurity @ Estonia"] },
            "The Voice Amplifier": { color: "#06b6d4", quote: "Journalism taught me every story deserves to be told. Your voice can change the world.", description: "You are passionate about journalism, storytelling, and advocating for important ideas.", recommendations: ["Media & Journalism @ Berita Harian", "Media & Journalism @ Tamil Murasu"] },
            "The Eco-Strategist": { color: "#22c55e", quote: "We don't inherit the Earth from our ancestors; we borrow it from our children.", description: "You are passionate about finding sustainable solutions, analysing environmental systems, and advocating for a greener future.", recommendations: ["Sustainability @ New Zealand", "Developing green campaigns"] }
        };

        const quizQuestions = [
            { question: "When facing a challenge, I first...", options: [ { text: "look for a tech solution.", archetype: "The Innovator" }, { text: "seek different perspectives.", archetype: "The Global Explorer" }, { text: "consider real applications.", archetype: "The Industry Trailblazer" }, { text: "think who needs help.", archetype: "The Community Steward" }, { text: "imagine a creative response.", archetype: "The Creative Artist" }, { text: "analyse patterns.", archetype: "The STEM Futurist" }, { text: "ask what story matters.", archetype: "The Voice Amplifier" }, { text: "assess the environmental impact.", archetype: "The Eco-Strategist" }] },
            { question: "I feel most energized when...", options: [ { text: "building something new.", archetype: "The Innovator" }, { text: "learning about cultures.", archetype: "The Global Explorer" }, { text: "seeing my work in action.", archetype: "The Industry Trailblazer" }, { text: "helping others grow.", archetype: "The Community Steward" }, { text: "performing or creating.", archetype: "The Creative Artist" }, { text: "solving complex puzzles.", archetype: "The STEM Futurist" }, { text: "sharing important ideas.", archetype: "The Voice Amplifier" }, { text: "working on a green initiative.", archetype: "The Eco-Strategist" }] },
            { question: "My ideal Beatty experience includes...", options: [ { text: "Machine Learning projects.", archetype: "The Innovator" }, { text: "international exchanges.", archetype: "The Global Explorer" }, { text: "industry attachments.", archetype: "The Industry Trailblazer" }, { text: "leading initiatives.", archetype: "The Community Steward" }, { text: "school concert performances.", archetype: "The Creative Artist" }, { text: "science research.", archetype: "The STEM Futurist" }, { text: "journalism opportunities.", archetype: "The Voice Amplifier" }, { text: "a school-wide sustainability project.", archetype: "The Eco-Strategist" }] },
            { question: "I learn best by...", options: [ { text: "tinkering, experimenting, and building prototypes.", archetype: "The Innovator" }, { text: "immersing myself in new environments.", archetype: "The Global Explorer" }, { text: "working on real-world projects.", archetype: "The Industry Trailblazer" }, { text: "leading a group.", archetype: "The Community Steward" }, { text: "expressing my ideas.", archetype: "The Creative Artist" }, { text: "conducting deep research.", archetype: "The STEM Futurist" }, { text: "interviewing experts.", archetype: "The Voice Amplifier" }, { text: "analysing systems.", archetype: "The Eco-Strategist" }] },
            { question: "For me, a successful future is one where I am...", options: [ { text: "creating technology.", archetype: "The Innovator" }, { text: "building bridges between cultures.", archetype: "The Global Explorer" }, { text: "at the top of my industry.", archetype: "The Industry Trailblazer" }, { text: "making a difference.", archetype: "The Community Steward" }, { text: "inspiring people.", archetype: "The Creative Artist" }, { text: "contributing to knowledge.", archetype: "The STEM Futurist" }, { text: "giving a voice to the voiceless.", archetype: "The Voice Amplifier" }, { text: "helping create a sustainable world.", archetype: "The Eco-Strategist" }] }
        ];
        
        function safeText(text) {
            if (text === undefined || text === null || text === "undefined") return "";
            return text;
        }

        function listenToSessionState() {
            onSnapshot(doc(db, "session", "state"), (doc) => {
                if (doc.exists()) {
                    renderView(doc.data());
                } else {
                    if (userData.aspiration) { renderMementoCard(); } 
                    else if (!userData.archetype) { renderQuizQuestion(); } 
                    else { renderWaiting(`Waiting for the presentation... <br><br>You are logged in as a <strong class="text-yellow-300 text-xl block mt-2">${safeText(userData.archetype)}</strong>`); }
                }
            });
        }
        
        function renderView(state) {
            if (!userData.archetype) { renderQuizQuestion(); return; }
            
            const title = safeText(state.title);
            const desc = safeText(state.description);

            switch(state.currentView) {
                case 'poll':
                    // Check if user already voted on this specific poll ID
                    if (userData.polls && userData.polls[state.pollData.id] !== undefined) {
                        // Retrieve the saved insight text to show them again
                        const savedVote = userData.polls[state.pollData.id];
                        renderWaiting(`Vote Recorded!<br><br>${savedVote.insight || 'Please watch the main screen.'}`);
                    } else {
                        renderPoll(state.pollData);
                    }
                    break;
                case 'globe': case 'industry_map':
                    if (userData[state.nexusData.type]) renderWaiting(`Your choice is on the map! <br>Watch the big screen.`);
                    else renderNexus(state.nexusData);
                    break;
                case 'finale': renderAspirationInput(); break;
                case 'memento': case 'end': renderMementoCard(); break;
                
                // --- PASSIVE/MIRRORING STATES ---
                case 'video':
                    appContainer.innerHTML = `
                    <div class="mirror-content fade-in w-full max-w-md">
                        <h2 class="text-2xl font-bold text-yellow-400 mb-2">Video Playing</h2>
                        <p class="text-gray-300">Look up at the main screen.</p>
                        <div class="mt-6 text-6xl animate-pulse">ðŸ“º</div>
                    </div>`;
                    break;
                case 'slide':
                    appContainer.innerHTML = `
                    <div class="mirror-content fade-in w-full max-w-md">
                        <h2 class="text-2xl font-bold text-yellow-400 mb-4">Presentation</h2>
                        <p class="text-lg mb-2">Look up at the main screen.</p>
                    </div>`;
                    break;
                case 'static': 
                     // Dream Values etc
                     if (state.staticContent) {
                         appContainer.innerHTML = `
                        <div class="mirror-content fade-in w-full max-w-md">
                            <h2 class="text-2xl font-bold text-yellow-400 mb-4">D.R.E.A.M Values</h2>
                            <p class="text-lg">Reflect on the values shown on screen.</p>
                        </div>`;
                     } else {
                        renderMirror(title, desc);
                     }
                    break;
                default:
                    renderWaiting(`Please watch the main screen.`);
            }
        }

        function renderMirror(title, description) {
            appContainer.innerHTML = `
                <div class="mirror-content fade-in w-full max-w-md">
                    <h2 class="text-xl font-bold text-yellow-400 mb-2">${title}</h2>
                    <p class="text-gray-300">${description}</p>
                    <div class="mt-6 animate-pulse text-yellow-500 text-4xl">ðŸ‘€</div>
                </div>`;
        }
        
        function renderQuizQuestion() {
            if (currentQuestionIndex >= quizQuestions.length) { determineArchetype(); return; }
            const questionData = quizQuestions[currentQuestionIndex];
            appContainer.innerHTML = `
                <div class="w-full max-w-lg text-center fade-in">
                    <p class="text-xs font-bold text-yellow-300 mb-2 tracking-widest uppercase">Beatty Compass Quiz (${currentQuestionIndex + 1}/${quizQuestions.length})</p>
                    <h2 class="text-2xl font-bold mb-6 leading-tight">${questionData.question}</h2>
                    <div class="grid grid-cols-1 gap-3">
                        ${questionData.options.map((opt) => `
                            <button data-archetype='${opt.archetype}' class="action-option w-full text-left p-5 bg-gray-800 border border-gray-600 rounded-xl text-base font-semibold shadow-lg active:bg-yellow-600">
                                ${opt.text}
                            </button>
                        `).join('')}
                    </div>
                </div>`;
        }
        
        function handleQuizAnswer(archetype) {
            quizChoices.push(archetype);
            currentQuestionIndex++;
            renderQuizQuestion();
        }

        async function determineArchetype() {
            const counts = {};
            for (const choice of quizChoices) { counts[choice] = (counts[choice] || 0) + 1; }
            let maxCount = 0;
            let finalArchetype = "The Innovator";
            for (const archetype in counts) { if (counts[archetype] > maxCount) { maxCount = counts[archetype]; finalArchetype = archetype; } }
            
            userData.archetype = finalArchetype;
            saveUserData();
            await setDoc(doc(db, "compassQuiz", auth.currentUser.uid), { archetype: userData.archetype, timestamp: serverTimestamp() });
            renderResult(userData.archetype);
        }

        function renderPoll(pollData) {
            appContainer.innerHTML = `
                <div class="w-full max-w-md text-center fade-in" data-poll-json='${JSON.stringify(pollData).replace(/'/g, "&apos;")}'>
                     <p class="text-sm font-bold text-yellow-300 mb-2 uppercase tracking-widest">Live Poll</p>
                     <h2 class="text-2xl font-bold mb-8 leading-snug">${pollData.question}</h2>
                     <div class="space-y-4">
                         ${pollData.options.map((opt, index) => `
                             <button data-poll-id="${pollData.id}" data-option-index="${index}" class="action-option w-full text-left p-5 bg-gray-800 border border-gray-600 rounded-xl shadow-md text-lg font-semibold">
                                 ${opt}
                             </button>
                         `).join('')}
                     </div>
                </div>`;
        }

        async function handlePollAnswer(pollId, optionIndex, pollData) {
            if (!userData.polls) userData.polls = {};
            const choiceIndex = parseInt(optionIndex);
            const choiceText = pollData.options[choiceIndex]; 
            const isCorrect = choiceIndex === pollData.correctAnswer;
            
            let insightText = pollData.insight || "Thanks for voting!";
            if (!isCorrect && pollData.correctAnswer !== undefined) {
                 insightText = `Good guess! <br><br>${pollData.insight}`;
            }

            userData.polls[pollId] = {
                choice: choiceIndex,
                choiceText: choiceText,
                isCorrect: isCorrect,
                insight: insightText
            };
            saveUserData();
            
            await setDoc(doc(db, "polls", `${pollId}_${auth.currentUser.uid}`), { pollId: pollId, vote: choiceIndex, timestamp: serverTimestamp() });
            renderWaiting(`Vote Recorded!<br><br>${insightText}`);
        }
        
        function renderNexus(nexusData) {
            appContainer.innerHTML = `
                <div class="w-full max-w-md text-center fade-in">
                    <h2 class="text-2xl font-bold mb-2">Chart Your Course</h2>
                    <p class="mb-6 text-gray-300">As a <strong class="text-yellow-300">${safeText(userData.archetype)}</strong>, which excites you?</p>
                    <div class="space-y-3">
                        ${nexusData.options.map(opt => `
                            <button data-nexus-id="${opt.id}" data-nexus-type="${nexusData.type}" data-nexus-text="${opt.text}" class="action-option w-full text-left p-4 bg-gray-800 border border-gray-600 rounded-xl shadow-md font-semibold">
                                ${opt.text}
                            </button>
                        `).join('')}
                    </div>
                </div>`;
        }
        
        async function handleNexusChoice(nexusId, nexusType, nexusText) {
            userData[nexusType] = { id: nexusId, text: nexusText };
            saveUserData();
            await setDoc(doc(db, "nexusVotes", auth.currentUser.uid), { nexusId: nexusId, timestamp: serverTimestamp() });
            renderWaiting("Your choice is on the map! <br>Look at the main screen.");
        }
        
        function renderAspirationInput() {
            if (userData.aspiration) { renderWaiting('Your aspiration is part of the crest!'); return; }
            appContainer.innerHTML = `
                <div class="w-full max-w-md text-center fade-in">
                    <h2 class="text-3xl font-bold mb-4 text-yellow-400">One Word.</h2>
                    <p class="mb-8 text-gray-300 text-lg">What is your future aspiration?<br>(e.g. Doctor, Innovator)</p>
                    <input type="text" id="aspirationInput" maxlength="15" class="w-full p-4 bg-gray-800 text-white border-2 border-blue-500 focus:border-yellow-400 rounded-xl mb-6 text-center text-2xl font-bold outline-none" placeholder="Type here...">
                    <button id="submitAspiration" class="w-full p-4 bg-yellow-400 text-blue-900 font-black text-xl rounded-xl shadow-lg uppercase tracking-wider">Add to Crest</button>
                </div>`;
        }

        async function handleAspirationSubmit() {
            const input = document.getElementById('aspirationInput');
            const word = input.value.trim();
            if (word) {
                input.disabled = true;
                document.getElementById('submitAspiration').disabled = true;
                document.getElementById('submitAspiration').textContent = "Sending...";
                userData.aspiration = word;
                saveUserData();
                await setDoc(doc(db, "aspirations", auth.currentUser.uid), { word: word, timestamp: serverTimestamp() });
                renderWaiting('Thank you! <br>Your aspiration is now part of our crest.');
            }
        }

        function renderMementoCard() {
            const archetypeData = archetypes[userData.archetype];
            if (!archetypeData) { renderError("Error", "Could not load your profile."); return; }
            
            // 1. Insights Logic (Aggregated from polls)
            let insightsHTML = "";
            const pollKeys = Object.keys(userData.polls || {});
            
            if (pollKeys.length > 0) {
                 const rawInsights = pollKeys.map(k => userData.polls[k].insight.replace("Good guess! <br><br>", "")); // Clean up formatting slightly
                 const uniqueInsights = [...new Set(rawInsights)].slice(0, 3); // Limit to 3 max
                 
                 insightsHTML = `
                 <div class="bg-slate-800 border-l-4 border-yellow-400 rounded-r-lg p-4 mb-4 shadow-lg">
                    <h4 class="font-bold text-yellow-400 uppercase tracking-wide text-xs mb-2">Your Insights</h4>
                    <ul class="space-y-3 text-xs text-gray-200 leading-relaxed">
                        ${uniqueInsights.map(txt => `<li>${txt}</li>`).join('')}
                    </ul>
                 </div>`;
            }

            // 2. Relational Pathways Logic
            const globalChoice = userData.global ? userData.global.text : "a future global exchange";
            const localChoice = userData.local ? userData.local.text : "a future industry attachment";
            const relationalText = `Brilliant! You've already set your sights on a global exchange to <strong>${globalChoice}</strong> and an industry attachment at <strong>${localChoice}</strong>. With 7 international exchanges and 7 industry attachments to choose from, we can't wait for you to pursue these opportunities to uncover your talents.`;

            // 3. Recommendations Logic
            const recommendationsText = `Keep in mind these options: ${archetypeData.recommendations.join(' â€¢ ')}. Get ready for your aspirations to take flight.`;

            appContainer.innerHTML = `
                <div class="w-full max-w-md text-center fade-in pb-8">
                    <!-- Card Container -->
                    <div id="memento-card" class="relative overflow-hidden rounded-3xl border-4 shadow-2xl text-left" style="border-color:${archetypeData.color}; background-color: #0f172a;">
                        
                        <!-- Header -->
                        <div class="p-6 pb-4 relative z-10">
                            <div class="flex items-center gap-4 mb-1">
                                <img src="https://raw.githubusercontent.com/harmanjohll/btyXperience/fc98005f3682a779482dd1bf5e7cff5f9adb8451/gem/BTlogo.png" alt="Beatty Crest" class="h-12 w-12 filter drop-shadow-md">
                                <div>
                                    <h1 class="text-2xl font-black leading-none tracking-tight" style="color:${archetypeData.color};">${safeText(userData.archetype)}</h1>
                                    <p class="text-[10px] text-gray-400 font-bold uppercase tracking-widest mt-1">Your Beatty Compass Card</p>
                                </div>
                            </div>
                        </div>

                        <!-- Quote Block -->
                        <div class="bg-slate-900/50 mx-4 p-4 rounded-xl border border-white/5 relative z-10">
                            <p class="text-sm italic text-gray-100 font-serif">"${archetypeData.quote}"</p>
                        </div>

                        <!-- Body Content -->
                        <div class="p-6 pt-4 relative z-10">
                            <p class="text-xs text-gray-300 mb-4 font-medium">${archetypeData.description}</p>

                            <!-- The Three Pillars -->
                            ${insightsHTML}

                            <div class="bg-blue-900/30 border border-blue-500/30 rounded-lg p-4 mb-4 shadow-lg">
                                <h4 class="font-bold text-yellow-400 uppercase tracking-wide text-xs mb-2">Your Chosen Pathways</h4>
                                <p class="text-xs text-gray-200 leading-relaxed">${relationalText}</p>
                            </div>

                            <div class="bg-slate-800/50 border-l-4 border-gray-500 rounded-r-lg p-4 shadow-lg">
                                <h4 class="font-bold text-yellow-400 uppercase tracking-wide text-xs mb-2">Recommended Pathways</h4>
                                <p class="text-xs text-gray-400 leading-relaxed">${recommendationsText}</p>
                            </div>
                        </div>

                        <!-- Footer -->
                        <div class="bg-black/40 p-6 text-center relative z-10 border-t border-white/10">
                             <p class="text-xs text-gray-400 mb-2">Join us at Beatty Secondary and have your aspiration to become a/an</p>
                             <p class="text-3xl font-black uppercase tracking-wide" style="color:${archetypeData.color}; text-shadow: 0 2px 10px rgba(0,0,0,0.5);">${safeText(userData.aspiration) || 'FUTURE LEADER'}</p>
                             <p class="text-xs text-gray-400 mt-1">take flight!</p>
                        </div>
                    </div>

                    <!-- Download Actions -->
                    <button id="downloadCardBtn" class="mt-8 w-full p-4 bg-yellow-400 text-blue-900 font-black rounded-xl shadow-xl text-lg uppercase tracking-wide hover:bg-white transition-colors">Download Card â¬‡</button>
                    <p class="text-xs text-gray-500 mt-3">Show this card at our booth for a gift!</p>
                </div>`;
        }

        function downloadCard() {
            const card = document.getElementById('memento-card');
            const btn = document.getElementById('downloadCardBtn');
            btn.textContent = "Generating...";
            btn.disabled = true;

            html2canvas(card, { backgroundColor: '#0f172a', scale: 3, useCORS: true }).then(canvas => {
                const link = document.createElement('a');
                link.download = 'Beatty-Compass-Card.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
                btn.textContent = "Download Card â¬‡";
                btn.disabled = false;
            }).catch(err => {
                console.error("Failed to generate canvas:", err);
                btn.textContent = "Download Failed.";
                btn.disabled = false;
            });
        }

        function saveUserData() { localStorage.setItem('btyxUserData_v4_final', JSON.stringify(userData)); }

        function renderResult(archetype) {
            appContainer.innerHTML = `
                <div class="w-full max-w-md text-center slide-in">
                    <h2 class="text-xl font-bold mb-2 text-gray-300">Your Compass Points To:</h2>
                    <p class="text-5xl font-black my-6" style="color: ${archetypes[archetype].color}">${archetype}</p>
                    <div class="p-4 bg-gray-800 rounded-xl mb-6 border border-gray-700">
                        <p class="text-gray-300 text-sm">Thank you! Your result has been added to the live chart.</p>
                    </div>
                    <p class="text-yellow-400 animate-pulse font-bold">Please watch the main screen.</p>
                    <button id="retakeQuizBtn" class="mt-8 text-sm text-gray-500 underline hover:text-white">Retake Quiz</button>
                </div>`;
        }
        
        function renderWaiting(message) {
            appContainer.innerHTML = `
                <div class="w-full max-w-md text-center slide-in">
                     <div class="animate-pulse mb-6"><svg class="mx-auto h-16 w-16 text-yellow-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></div>
                     <p class="text-xl font-semibold leading-relaxed">${message}</p>
                </div>`;
        }
        
        function renderError(title, message) {
            appContainer.innerHTML = `<div class="text-center p-6 bg-red-900/80 rounded-xl border border-red-500 m-4"><h2 class="text-2xl font-bold mb-2">${title}</h2><p>${message}</p></div>`;
        }

        function retakeQuiz() {
            localStorage.removeItem('btyxUserData_v4_final');
            location.reload();
        }

        appContainer.addEventListener('click', (e) => {
            const target = e.target.closest('button');
            if (!target) return;
            
            if (target.id === 'retakeQuizBtn') { retakeQuiz(); return; }
            if (target.id === 'downloadCardBtn') { downloadCard(); return; }
            if (target.id === 'submitAspiration') { handleAspirationSubmit(); return; }

            const pollContainer = target.closest('[data-poll-json]');
            
            if (target.dataset.archetype) {
                target.disabled = true;
                target.innerHTML = "Selected";
                handleQuizAnswer(target.dataset.archetype);
            }
            else if (target.dataset.pollId && pollContainer) {
                const pollData = JSON.parse(pollContainer.dataset.pollJson);
                const allButtons = pollContainer.querySelectorAll('button');
                allButtons.forEach(btn => { btn.disabled = true; btn.classList.add('opacity-50'); });
                target.classList.remove('opacity-50');
                target.classList.add('ring-2', 'ring-yellow-400');
                handlePollAnswer(target.dataset.pollId, target.dataset.optionIndex, pollData);
            }
            else if (target.dataset.nexusId) {
                target.disabled = true;
                handleNexusChoice(target.dataset.nexusId, target.dataset.nexusType, target.dataset.nexusText);
            }
        });
    </script>
</body>
</html>
