<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Passport: Set Sail @ Beatty</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            btyBlue: '#000C53',
            btyYellow: '#FFE200',
            btyRed: '#EC3237',
            midnight: '#070B24'
          },
          fontFamily: {
            sans: ['Lato', 'ui-sans-serif', 'system-ui']
          }
        }
      }
    };
  </script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;600;700;900&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="/styles.css" />
</head>
<body class="min-h-screen bg-gradient-to-br from-midnight via-btyBlue/80 to-black font-sans text-white/90">
  <main class="mx-auto flex w-full max-w-3xl flex-col gap-6 px-5 py-12">
    <header class="flex items-center justify-between gap-3">
      <div class="flex items-center gap-3">
        <img src="/content/assets/BTlogo.png" class="h-20 w-20 rounded-full border border-white/20 bg-white/20 p-3" alt="Beatty crest" />
        <div>
          <p class="text-xs uppercase tracking-[0.3em] text-btyYellow">Passport: Set Sail @ Beatty</p>
          <h1 class="text-xl font-bold text-white">Shape today&#39;s experience with us</h1>
        </div>
      </div>
      <div id="timeline-banner" class="hidden rounded-full border border-white/20 bg-white/10 px-4 py-2 text-xs text-white/70"></div>
    </header>

    <section id="join-card" class="space-y-6 rounded-3xl border border-white/15 bg-white/8 p-6 shadow-lg">
      <div>
        <h2 class="text-2xl font-black text-white">Quick set-up</h2>
        <p class="mt-1 text-sm text-white/70">Select your role and up to three interests. Everything stays anonymous.</p>
      </div>
      <div>
        <p class="text-xs uppercase tracking-[0.3em] text-btyYellow">Role</p>
        <div class="mt-3 flex gap-3">
          <label class="role-option flex-1 cursor-pointer rounded-2xl border border-white/20 bg-white/5 p-4 text-center">
            <input type="radio" name="role" value="student" class="hidden" checked />
            <span class="block text-sm font-semibold text-white">Student</span>
            <span class="mt-1 block text-xs text-white/60">I hope my secondary school helps me deepen these passions.</span>
          </label>
          <label class="role-option flex-1 cursor-pointer rounded-2xl border border-white/20 bg-white/5 p-4 text-center">
            <input type="radio" name="role" value="parent" class="hidden" />
            <span class="block text-sm font-semibold text-white">Parent</span>
            <span class="mt-1 block text-xs text-white/60">I cheer my child on to pursue these interests.</span>
          </label>
        </div>
      </div>
      <div>
        <p class="text-xs uppercase tracking-[0.3em] text-btyYellow">Interests (pick up to three)</p>
        <div id="interest-grid" class="mt-3 grid grid-cols-2 gap-3 text-sm"></div>
        <p id="selection-summary" class="mt-3 text-sm text-white/70">You have 0 interests selected.</p>
      </div>
      <button id="join-btn" class="w-full rounded-2xl bg-btyYellow py-3 text-center text-xs font-bold uppercase tracking-[0.3em] text-btyBlue transition hover:bg-yellow-300">Join session</button>
    </section>

    <section id="live-card" class="hidden space-y-5 rounded-3xl border border-white/15 bg-white/8 p-6 shadow-lg">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-xs uppercase tracking-[0.3em] text-btyYellow">Live interaction</p>
          <h2 id="live-title" class="text-2xl font-black text-white">Welcome!</h2>
        </div>
        <span id="status-chip" class="rounded-full border border-white/20 px-3 py-1 text-xs text-white/60">Standby</span>
      </div>
      <div id="live-panel" class="space-y-4 text-sm text-white/80"></div>
      <p class="text-xs text-white/50">Prompts update automatically &mdash; stay on this page.</p>
    </section>

    <section id="journey-card" class="hidden space-y-5 rounded-3xl border border-white/15 bg-white/8 p-6 shadow-lg">
      <div id="journey-preview" class="space-y-5">
        <div>
          <p class="text-xs uppercase tracking-[0.3em] text-btyYellow">Your Journey Card</p>
          <h2 class="text-2xl font-black text-white">Snapshot of your choices</h2>
          <p class="mt-1 text-sm text-white/70">Show this to a Beatty teacher or student host to dive deeper.</p>
        </div>
        <div id="journey-summary" class="space-y-3 text-sm text-white/80"></div>
      </div>
      <div class="grid gap-3 sm:grid-cols-2">
        <button id="download-png" class="rounded-2xl border border-btyYellow bg-btyYellow/20 py-3 text-sm font-semibold text-btyYellow hover:bg-btyYellow/30">Download PNG</button>
        <button id="download-jpg" class="rounded-2xl border border-btyYellow bg-btyYellow/10 py-3 text-sm font-semibold text-btyYellow/80 hover:bg-btyYellow/25">Download JPG</button>
        <button id="download-pdf" class="rounded-2xl border border-btyYellow bg-btyYellow/10 py-3 text-sm font-semibold text-btyYellow/80 hover:bg-btyYellow/20">Download PDF</button>
        <button id="download-json" class="rounded-2xl border border-white/20 bg-white/10 py-3 text-sm font-semibold text-white/80 hover:bg-white/15">Download JSON</button>
      </div>
    </section>
  </main>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" integrity="sha512-BNa5oLSFe3cy8CXU7a2fjS3tM3+E1Jd+Y5S2sHPyU6CI9+VFeReyqYhB1tZEDf9y25epB7IrJ0Z2nEJ7prNruA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" integrity="sha512-PTG7dYBeb5GsyhQOdE31E4n4t4tPcNI0YvrFica8FWHQrFMizxgxYkWwaP42gnikIze8ih/7gToYtYjDjN8asA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="/app.js"></script>
  <script>
    const INTERESTS = [
      'Robotics',
      'AI: From Machine Learning to Vibe Coding',
      'Design & Making',
      'Sports',
      'Performing Arts',
      'Industry',
      'Leadership',
      'Community Engagement & Service',
      'Nature',
      'STEM',
      'Media',
      'Global Experiences'
    ];

    const moodList = [
      { id: 'curiosity', label: 'Curiosity' },
      { id: 'confidence', label: 'Confidence' },
      { id: 'belonging', label: 'Belonging' },
      { id: 'joy', label: 'Joy' },
      { id: 'purpose', label: 'Purpose' },
      { id: 'growth', label: 'Growth' },
      { id: 'focused', label: 'Focused Discipline' },
      { id: 'adaptable', label: 'Adaptable Spirit' },
      { id: 'mindful', label: 'Calm & Mindful' },
      { id: 'resilient', label: 'Resilient Heart' }
    ];

    const moodDescriptions = {
      curiosity: 'Curiosity keeps your learning fresh and hands-on.',
      confidence: 'Confidence powers you to take brave next steps.',
      belonging: 'Belonging anchors you within a caring Beatty crew.',
      joy: 'Joy reminds you to celebrate every small win.',
      purpose: 'Purpose keeps your eyes on meaningful contributions.',
      growth: 'Growth mindset stretches you beyond comfort zones.',
      focused: 'Focused discipline sharpens your craft each week.',
      adaptable: 'Adaptable spirit helps you pivot with agility.',
      mindful: 'Calm mindfulness centres you amid busy days.',
      resilient: 'Resilient heart lets you bounce back stronger.'
    };

    const PERSONA_PROFILES = {
      explorer: {
        title: 'Explorer',
        summary: 'You love getting into new spaces and learning by doing. You are curious, adventurous, and ready to map the unknown.',
        narrative: 'Beatty opens doors for you to test ideas across AI labs, global classrooms, and cross-disciplinary quests.',
        highlights: [
          'NEXUS@BTY expeditions, e-Exchanges, and Estonia collaborations',
          'Applied Learning Programme: Machine Learning studios & design sprints',
          'Global inquiry trails and overseas industry attachments'
        ]
      },
      guardian: {
        title: 'Guardian',
        summary: 'You naturally rally others and ensure every solution uplifts the community. You thrive when hearts and hands work together.',
        narrative: 'You will keep rallying Beattyians through LLP leadership journeys and purposeful service that leaves a mark.',
        highlights: [
          'Learning for Life Programme: SHARP leadership & community projects',
          'Parallel Curriculum pathways grounded in empathy and service',
          'Active contributor platforms like the DREAMS concert for President\'s Challenge'
        ]
      },
      trailblazer: {
        title: 'Trailblazer',
        summary: 'You love creativity, innovation, and leading the next move. You see technology and new industries as launchpads for bold ideas.',
        narrative: 'Beatty hands you real-world briefs so you can prototype bold solutions and lead the charge into emerging industries.',
        highlights: [
          'Industry attachments with partners such as Rockwell Automation and A*STAR',
          'AI and data storytelling labs inside our makerspaces',
          'Entrepreneurial challenges that sharpen your voice and influence'
        ]
      },
      storyteller: {
        title: 'Storyteller',
        summary: 'You express ideas in memorable ways. Whether through art, music, writing, or performance, you inspire Beattyians around you.',
        narrative: 'Your creativity finds its spotlight in Beatty through performances, media labs, and campaigns that move hearts.',
        highlights: [
          'DREAMS Concert and President\'s Challenge productions that champion causes',
          'Media and communications clubs, including journalism and broadcast opportunities',
          'Studios to compose, paint, film, and lead creative collaborations'
        ]
      },
      navigator: {
        title: 'Navigator',
        summary: 'You bring focus, discipline, and strategy. You keep teams organised, plans on track, and goals stretching higher each week.',
        narrative: 'Beatty equips you with frameworks, mentors, and milestones so every team you guide stays disciplined and adaptive.',
        highlights: [
          'Student leadership councils, house committees, and class executive roles',
          'STEM, design thinking, and NX101 project labs for structured problem-solving',
          'Reflection and resilience programmes that strengthen discipline and mindfulness'
        ]
      }
    };

    const PERSONA_KEYS = Object.keys(PERSONA_PROFILES);

        const personaQuestions = [
      {
        prompt: 'When you and/or your team faces a tough challenge, your first instinct is to...',
        options: [
          { label: 'Brainstorm a new, tech-driven solution.', persona: 'trailblazer' },
          { label: 'Organise the team and create a clear plan.', persona: 'navigator' },
          { label: 'Ensure the solution helps the community.', persona: 'guardian' },
          { label: 'Research the problem\'s root cause.', persona: 'explorer' }
        ]
      },
      {
        prompt: 'You have a free afternoon on Saturday. What are you most likely to do?',
        options: [
          { label: 'Explore a new place of culture.', persona: 'explorer' },
          { label: 'Write, draw, paint, or create music.', persona: 'storyteller' },
          { label: 'Hang out with some friends and play non-digital games.', persona: 'guardian' },
          { label: 'Organise my home and plan for the week ahead.', persona: 'navigator' }
        ]
      },
      {
        prompt: 'You are most energised when you are...',
        options: [
          { label: 'Discovering something no one else had noticed.', persona: 'explorer' },
          { label: 'Leading a group in working towards a common objective.', persona: 'trailblazer' },
          { label: 'Making a positive impact on a community.', persona: 'guardian' },
          { label: 'Expressing your ideas in front of an audience.', persona: 'storyteller' }
        ]
      }
    ];

    function formatList(items) {
      if (!items || items.length === 0) return '';
      if (items.length === 1) return items[0];
      const leading = items.slice(0, -1).join(', ');
      const last = items[items.length - 1];
      return `${leading} & ${last}`;
    }

    const interestGrid = document.getElementById('interest-grid');
    INTERESTS.forEach(label => {
      const id = `interest-${label.replace(/\s+/g, '-')}`;
      const wrapper = document.createElement('label');
      wrapper.className = 'interest-option flex cursor-pointer items-center gap-2 rounded-2xl border border-white/20 bg-white/5 px-3 py-3 text-sm text-white/80 hover:border-btyYellow/60';
      wrapper.innerHTML = `<input type="checkbox" value="${label}" id="${id}" class="hidden" /><span>${label}</span>`;
      interestGrid.appendChild(wrapper);
    });

    const roleInputs = document.querySelectorAll('input[name="role"]');
    const roleOptions = document.querySelectorAll('.role-option');
    const interestInputs = Array.from(document.querySelectorAll('#interest-grid input'));
    const joinBtn = document.getElementById('join-btn');
    const joinCard = document.getElementById('join-card');
    const liveCard = document.getElementById('live-card');
    const livePanel = document.getElementById('live-panel');
    const liveTitle = document.getElementById('live-title');
    const statusChip = document.getElementById('status-chip');
    const interestSummary = document.getElementById('selection-summary');
    const timelineBanner = document.getElementById('timeline-banner');
    const journeyCard = document.getElementById('journey-card');
    const journeyPreview = document.getElementById('journey-preview');
    const journeySummary = document.getElementById('journey-summary');
    const downloadPngButton = document.getElementById('download-png');
    const downloadJpgButton = document.getElementById('download-jpg');
    const downloadPdfButton = document.getElementById('download-pdf');
    const downloadJsonButton = document.getElementById('download-json');

    const user = {
      role: 'student',
      interests: [],
      persona: null,
      personaBreakdown: {},
      moods: [],
      pollChoice: null,
      stamps: []
    };

    function updateRoleUI() {
      roleOptions.forEach(option => option.classList.remove('ring-2', 'ring-btyYellow', 'bg-btyYellow/10'));
      roleInputs.forEach(input => {
        if (input.checked) {
          const parent = input.closest('label');
          if (parent) parent.classList.add('ring-2', 'ring-btyYellow', 'bg-btyYellow/10');
          user.role = input.value;
        }
      });
    }

    function updateInterestUI() {
      const selected = interestInputs.filter(input => input.checked).slice(0, 3);
      interestInputs.forEach(input => {
        const label = input.closest('label');
        if (!label) return;
        if (selected.includes(input)) label.classList.add('border-btyYellow/60', 'bg-btyYellow/10');
        else label.classList.remove('border-btyYellow/60', 'bg-btyYellow/10');
      });
      user.interests = selected.map(input => input.value);
      if (selected.length >= 3) {
        interestInputs.forEach(input => {
          if (!user.interests.includes(input.value)) input.checked = false;
        });
      }
      if (user.interests.length) {
        interestSummary.textContent = `You selected ${user.interests.length} interest${user.interests.length > 1 ? 's' : ''}: ${formatList(user.interests) }.`;
      } else {
        interestSummary.textContent = 'You have 0 interests selected.';
      }
    }

    roleInputs.forEach(input => input.addEventListener('change', updateRoleUI));
    interestInputs.forEach(input => input.addEventListener('change', () => {
      const selected = interestInputs.filter(i => i.checked);
      if (selected.length > 3) {
        input.checked = false;
      }
      updateInterestUI();
    }));

    updateRoleUI();
    updateInterestUI();

    joinBtn.addEventListener('click', async () => {
      await API.send('join', { role: user.role, interests: user.interests });
      joinCard.classList.add('hidden');
      liveCard.classList.remove('hidden');
      liveTitle.textContent = 'Welcome!';
      livePanel.innerHTML = '<p class="text-sm text-white/70">Thanks for joining. A feelings pulse is coming up - tap the emotions you want most in secondary school.</p>';
      statusChip.textContent = 'Connected';
      statusChip.classList.add('border-btyYellow/60', 'text-btyYellow');
    });

    function renderMoodPrompt() {
      user.moods = [];
      liveTitle.textContent = 'How do you want to feel?';
      statusChip.textContent = 'Mood pulse';
      livePanel.innerHTML = `<p class="text-sm text-white/70">What are two most important feelings you would like from your secondary school experience? Think about values like discipline, adaptability, mindfulness, and resilience as you choose.</p><div class="grid gap-3 md:grid-cols-2" id="mood-grid"></div><p id="mood-feedback" class="text-xs text-white/60">Select up to two feelings.</p>`;
      const grid = document.getElementById('mood-grid');
      grid.innerHTML = moodList.map(m => `<button class="choice-btn" data-mood="${m.id}">${m.label}</button>`).join('');
      const feedback = document.getElementById('mood-feedback');
      grid.querySelectorAll('button').forEach(btn => {
        btn.addEventListener('click', () => {
          const moodId = btn.dataset.mood;
          if (user.moods.includes(moodId)) return;
          if (user.moods.length >= 2) return;
          user.moods.push(moodId);
          API.send('mood', { id: moodId });
          btn.classList.add('selected');
          btn.disabled = true;
          user.stamps.push(`Mood-${moodId}`);
          if (user.moods.length === 1) {
            feedback.textContent = 'Great choice! Pick one more feeling if you wish.';
          } else {
            const moodLabels = user.moods.map(id => moodList.find(m => m.id === id)?.label || id);
            feedback.textContent = `Locked in: ${formatList(moodLabels)}.`;
            grid.querySelectorAll('button').forEach(other => {
              if (!user.moods.includes(other.dataset.mood)) {
                other.disabled = true;
                other.classList.add('disabled');
              }
            });
          }
        });
      });
    }

    let personaIndex = 0;
    let personaScores = {};

    function resetPersonaJourney() {
      personaIndex = 0;
      personaScores = {};
      PERSONA_KEYS.forEach(key => (personaScores[key] = 0));
      user.persona = null;
      user.personaBreakdown = {};
    }

    function renderPersonaQuestion() {
      const question = personaQuestions[personaIndex];
      liveTitle.textContent = 'Persona spotlight';
      statusChip.textContent = `Question ${personaIndex + 1} of ${personaQuestions.length}`;
      livePanel.innerHTML = `<p class="text-sm text-white/70">${question.prompt}</p><div class="grid gap-3" id="persona-grid"></div><p class="text-xs text-white/60">Choose the option that sounds most like you.</p>`;
      const grid = document.getElementById('persona-grid');
      grid.innerHTML = question.options.map(option => `
        <button class="choice-card" data-persona="${option.persona}">
          <strong class="text-sm font-semibold text-white">${option.label}</strong>
        </button>`).join('');
      grid.querySelectorAll('button').forEach(btn => {
        btn.addEventListener('click', () => {
          const personaKey = btn.dataset.persona;
          if (!personaKey) return;
          personaScores[personaKey] += 1;
          btn.classList.add('selected');
          grid.querySelectorAll('button').forEach(other => {
            if (other !== btn) {
              other.disabled = true;
              other.classList.add('disabled');
            }
          });
          setTimeout(() => {
            personaIndex += 1;
            if (personaIndex < personaQuestions.length) {
              renderPersonaQuestion();
            } else {
              completePersonaJourney();
            }
          }, 350);
        }, { once: true });
      });
    }

    function completePersonaJourney() {
      const ordered = Object.entries(personaScores).sort((a, b) => b[1] - a[1]);
      user.personaBreakdown = Object.fromEntries(ordered);
      const [topPersona] = ordered[0] || ['explorer', 0];
      user.persona = topPersona;
      if (!user.stamps.some(stamp => stamp.startsWith('Persona-'))) {
        user.stamps.push(`Persona-${topPersona}`);
      }
      API.send('persona', { id: topPersona });
      const profile = PERSONA_PROFILES[topPersona];
      const runnerUps = ordered.slice(1, 3).filter(([, score]) => score > 0).map(([key]) => PERSONA_PROFILES[key].title);
      const runnerText = runnerUps.length ? `<p class="text-xs text-white/50">You also showed hints of ${runnerUps.join(' and ')}.</p>` : '';
      const narrativeText = profile.narrative ? `<p class="text-sm text-white/65">${profile.narrative}</p>` : '';
      const highlightList = profile.highlights.map(item => `<li class="rounded-xl border border-white/15 bg-white/5 px-3 py-2 text-sm text-white/80">${item}</li>`).join('');
      liveTitle.textContent = `${profile.title} at Beatty`;
      statusChip.textContent = 'Persona insight';
      livePanel.innerHTML = `
        <div class="space-y-3">
          <p class="text-sm text-white/70">${profile.summary}</p>
          ${narrativeText}
          ${runnerText}
          <div class="rounded-2xl border border-white/15 bg-white/5 p-4">
            <p class="text-xs uppercase tracking-[0.3em] text-btyYellow">Programmes to watch</p>
            <ul class="mt-2 space-y-2">
              ${highlightList}
            </ul>
          </div>
        </div>`;
    }

    function startPersonaJourney() {
      resetPersonaJourney();
      renderPersonaQuestion();
    }

    function renderPoll(poll) {
      if (!poll) return;
      user.pollChoice = null;
      liveTitle.textContent = 'Live poll';
      statusChip.textContent = 'Poll';
      livePanel.innerHTML = `<p class="text-sm text-white/70">${poll.question}</p><div id="poll-grid" class="grid gap-3 md:grid-cols-2"></div><p id="poll-feedback" class="text-xs text-white/60">Tap the option you believe is correct.</p>`;
      const grid = document.getElementById('poll-grid');
      grid.innerHTML = poll.options.map(opt => `<button class="choice-btn" data-opt="${opt.id}">${opt.label}</button>`).join('');
      grid.querySelectorAll('button').forEach(btn => {
        btn.addEventListener('click', () => {
          if (user.pollChoice) return;
          user.pollChoice = btn.textContent;
          API.send('poll:vote', { optionId: Number(btn.dataset.opt) });
          btn.classList.add('selected');
          grid.querySelectorAll('button').forEach(other => {
            if (other !== btn) {
              other.disabled = true;
              other.classList.add('disabled');
            }
          });
          document.getElementById('poll-feedback').textContent = `Locked in: ${user.pollChoice}.`;
          user.stamps.push('Poll');
        }, { once: true });
      });
    }

    function renderFinale() {
      liveTitle.textContent = 'Thank you!';
      statusChip.textContent = 'Finale';
      livePanel.innerHTML = '<p class="text-sm text-white/70">We just sent a final highlight to the Stage. Review your Journey Card below and speak to a Beatty teacher or student host.</p>';
      journeyCard.classList.remove('hidden');
      const profile = PERSONA_PROFILES[user.persona] || PERSONA_PROFILES.explorer;
      const personaTitle = profile.title;
      const roleLine = user.role === 'parent'
        ? 'You joined as a parent ready to cheer your child towards purposeful opportunities.'
        : 'You joined as a student eager to chart a meaningful Beatty journey.';
      const personaLine = `As a <span class="font-semibold text-white">${personaTitle}</span>, ${profile.summary}`;
      const personaNarr = profile.narrative ? profile.narrative : '';
      const moodLabels = user.moods.map(id => moodList.find(m => m.id === id)?.label || id);
      const moodDetails = user.moods.map(id => moodDescriptions[id]).filter(Boolean);
      const moodNarrative = moodLabels.length
        ? `You want your Beatty experience to feel ${formatList(moodLabels)}. ${moodDetails.join(' ')}`
        : 'You are open to discovering how Beatty will move you.';
      const interestsSelected = user.interests.slice(0, 4);
      const interestNarrative = interestsSelected.length
        ? `Your eyes lit up for ${formatList(interestsSelected)}, so we will pair you with showcases, mentors, and studios that help you deepen these passions.`
        : 'You are ready to sample different pathways, and our hosts will guide you to tasters across the campus.';
      const pathways = profile.highlights.map(item => `<li class="rounded-xl border border-white/15 bg-white/5 px-3 py-2">${item}</li>`).join('');
      const closing = 'Whether it\'s sports or the arts, cutting-edge application of AI, nurturing yourself to relate with others, global experiences and industry networking, you will find it at Beatty Secondary. We can\'t wait to set sail with you as you discover your gifts and create possibilities.';
      journeySummary.innerHTML = `
        <div class="space-y-3 text-sm text-white/75">
          <p class="text-sm text-white/70">${roleLine}</p>
          <p class="text-sm text-white/80">${personaLine}</p>
          ${personaNarr ? `<p class="text-sm text-white/70">${personaNarr}</p>` : ''}
          <p class="text-sm text-white/70">${moodNarrative}</p>
          <p class="text-sm text-white/70">${interestNarrative}</p>
          <div class="rounded-2xl border border-white/15 bg-white/5 p-4">
            <p class="text-xs uppercase tracking-[0.3em] text-btyYellow">Experiences made for you</p>
            <ul class="mt-2 space-y-2 text-sm text-white/80">
              ${pathways}
            </ul>
          </div>
          <p class="text-sm text-white/80">${closing}</p>
          <p class="text-xs text-white/50">Moments captured: <span class="font-semibold text-white">${user.stamps.join(' | ') || 'Keep exploring'}</span></p>
        </div>`;
    }

    async function exportJourneyCard(format) {
      const target = journeyPreview;
      if (!target) return;
      if (format === 'json') {
        const data = {
          role: user.role,
          interests: user.interests,
          persona: user.persona,
          personaBreakdown: user.personaBreakdown,
          moods: user.moods,
          pollChoice: user.pollChoice,
          stamps: user.stamps,
          generatedAt: new Date().toISOString()
        };
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `beatty-journey-card-${Date.now()}.json`;
        a.click();
        URL.revokeObjectURL(url);
        return;
      }
      if (typeof html2canvas !== 'function') {
        alert('Download not ready yet. Please try again in a moment.');
        return;
      }
      const previousStatus = statusChip.textContent;
      statusChip.textContent = 'Preparing download';
      try {
        const canvas = await html2canvas(target, { backgroundColor: '#070B24', scale: 2, useCORS: true, logging: false });
        if (format === 'png') {
          const url = canvas.toDataURL('image/png');
          const a = document.createElement('a');
          a.href = url;
          a.download = `beatty-journey-card-${Date.now()}.png`;
          a.click();
        } else if (format === 'jpg') {
          const url = canvas.toDataURL('image/jpeg', 0.9);
          const a = document.createElement('a');
          a.href = url;
          a.download = `beatty-journey-card-${Date.now()}.jpg`;
          a.click();
        } else if (format === 'pdf' && window.jspdf && window.jspdf.jsPDF) {
          const imgData = canvas.toDataURL('image/png');
          const pdf = new window.jspdf.jsPDF('p', 'mm', 'a4');
          const pageWidth = pdf.internal.pageSize.getWidth();
          const pageHeight = pdf.internal.pageSize.getHeight();
          const aspect = canvas.width / canvas.height;
          let renderWidth = pageWidth - 20;
          let renderHeight = renderWidth / aspect;
          if (renderHeight > pageHeight - 20) {
            renderHeight = pageHeight - 20;
            renderWidth = renderHeight * aspect;
          }
          pdf.addImage(imgData, 'PNG', (pageWidth - renderWidth) / 2, 10, renderWidth, renderHeight);
          pdf.save(`beatty-journey-card-${Date.now()}.pdf`);
        }
        statusChip.textContent = 'Download ready';
      } catch (err) {
        statusChip.textContent = 'Download failed';
      } finally {
        setTimeout(() => {
          statusChip.textContent = previousStatus;
        }, 2000);
      }
    }

    downloadPngButton?.addEventListener('click', () => exportJourneyCard('png'));
    downloadJpgButton?.addEventListener('click', () => exportJourneyCard('jpg'));
    downloadPdfButton?.addEventListener('click', () => exportJourneyCard('pdf'));
    downloadJsonButton?.addEventListener('click', () => exportJourneyCard('json'));

    API.onEvent((type, data) => {
      if (type === 'scene') {
        if (data.scene === 'pulse') {
          renderMoodPrompt();
        } else if (data.scene === 'persona') {
          startPersonaJourney();
        } else if (data.scene === 'tracks') {
          liveTitle.textContent = 'Imagine - Create - Explore';
          livePanel.innerHTML = '<p class="text-sm text-white/70">Watch the Stage for videos and spotlights on our Imagine, Create, and Explore tracks. Your persona insights are coming up next.</p>';
          statusChip.textContent = 'Tracks showcase';
        } else if (data.scene === 'social') {
          liveTitle.textContent = 'Beatty in action';
          livePanel.innerHTML = '<p class="text-sm text-white/70">Stories from our community are on the Stage screen now.</p>';
          statusChip.textContent = 'Highlights';
        } else if (data.scene === 'finale') {
          renderFinale();
        }
      }

      if (type === 'poll:start') {
        renderPoll(data);
      }

      if (type === 'poll:reveal') {
        const answerText = data?.answerText || 'Answer revealed.';
        const answerLabel = answerText.replace(/^Correct:\s*/, '').trim().toLowerCase();
        statusChip.textContent = 'Poll results';
        if (data?.options) {
          const total = data.options.reduce((sum, opt) => sum + (opt.count || 0), 0) || 1;
          const list = data.options.map(opt => {
            const pct = Math.round(((opt.count || 0) / total) * 100);
            const isCorrect = answerLabel && opt.label.toLowerCase() === answerLabel;
            const borderClass = isCorrect ? 'border-2 border-btyRed shadow-[0_0_16px_rgba(236,50,55,0.6)]' : 'border border-white/15';
            return `<li class="rounded-xl ${borderClass} bg-white/5 px-3 py-2 flex justify-between"><span>${opt.label}</span><span>${opt.count || 0} (${pct}%)</span></li>`;
          }).join('');
          livePanel.innerHTML = `<p class="text-sm text-white/70">${answerText}</p><ul class="mt-3 space-y-2 text-sm text-white/80">${list}</ul>`;
        } else {
          livePanel.innerHTML = `<p class="text-sm text-white/70">${answerText}</p>`;
        }
      }

      if (type === 'timeline:status') {
        if (data.active) {
          timelineBanner.classList.remove('hidden');
          timelineBanner.textContent = `Auto flow - ${data.label}`;
        } else {
          timelineBanner.classList.add('hidden');
        }
      }
    });
  </script>
</body>
</html>
