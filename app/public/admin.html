<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Beatty Presenter Console</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            btyBlue: '#000C53',
            btyYellow: '#FFE200',
            btyRed: '#EC3237',
            midnight: '#070B24'
          },
          fontFamily: {
            sans: ['Lato', 'ui-sans-serif', 'system-ui']
          }
        }
      }
    };
  </script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;600;700;900&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="/styles.css" />
</head>
<body class="min-h-screen bg-gradient-to-br from-midnight via-btyBlue/80 to-black font-sans text-white/90">
  <main class="mx-auto flex w-full max-w-5xl flex-col gap-6 px-6 py-10">
    <header id="section-overview" class="flex flex-col gap-6 rounded-3xl border border-white/15 bg-white/5 p-6 shadow-xl lg:flex-row lg:items-center lg:justify-between">
      <div class="space-y-4">
        <div>
          <p class="text-xs uppercase tracking-[0.3em] text-btyYellow">Presenter console</p>
          <h1 class="text-3xl font-black text-white">Guide the Beatty experience with confidence</h1>
        </div>
        <ul class="space-y-2 text-sm text-white/70">
          <li>&bull; Move through the Join &rarr; Feelings &rarr; Persona &rarr; NEXUS &rarr; Poll &rarr; Finale flow.</li>
          <li>&bull; Use each section's stage trigger when you are ready to change what the audience sees.</li>
          <li>&bull; Capture highlights as you go so the finale recap and Journey Cards stay current.</li>
        </ul>
      </div>
      <div class="grid gap-3 rounded-3xl border border-white/15 bg-white/5 p-5 text-sm text-white/70">
        <div class="flex flex-col gap-1">
          <span class="text-xs uppercase tracking-[0.3em] text-btyYellow">Current scene</span>
          <span id="current-scene" class="text-2xl font-black text-white">join</span>
        </div>
        <div class="flex flex-col gap-1">
          <span class="text-xs uppercase tracking-[0.3em] text-btyYellow">Flow status</span>
          <span id="timeline-status">Manual control active.</span>
        </div>
        <div class="flex flex-col gap-1">
          <span class="text-xs uppercase tracking-[0.3em] text-btyYellow">Journey cards saved</span>
          <span class="text-xl font-semibold text-white" id="journey-count">0</span>
        </div>
      </div>
    </header>

    <nav id="section-nav" class="sticky top-4 z-40 rounded-3xl border border-white/15 bg-white/10 p-4 backdrop-blur-md">
      <div class="flex flex-wrap gap-3">
        <button class="jump-btn rounded-2xl border border-white/15 px-4 py-2 text-xs font-semibold uppercase tracking-[0.3em] text-white/80 hover:border-btyYellow hover:text-white" data-target="section-join">Join</button>
        <button class="jump-btn rounded-2xl border border-white/15 px-4 py-2 text-xs font-semibold uppercase tracking-[0.3em] text-white/80 hover:border-btyYellow hover:text-white" data-target="section-feelings">Feelings pulse</button>
        <button class="jump-btn rounded-2xl border border-white/15 px-4 py-2 text-xs font-semibold uppercase tracking-[0.3em] text-white/80 hover:border-btyYellow hover:text-white" data-target="section-persona">Persona spotlight</button>
        <button class="jump-btn rounded-2xl border border-white/15 px-4 py-2 text-xs font-semibold uppercase tracking-[0.3em] text-white/80 hover:border-btyYellow hover:text-white" data-target="section-nexus">NEXUS showcase</button>
        <button class="jump-btn rounded-2xl border border-white/15 px-4 py-2 text-xs font-semibold uppercase tracking-[0.3em] text-white/80 hover:border-btyYellow hover:text-white" data-target="section-poll">Poll</button>
        <button class="jump-btn rounded-2xl border border-white/15 px-4 py-2 text-xs font-semibold uppercase tracking-[0.3em] text-white/80 hover:border-btyYellow hover:text-white" data-target="section-finale">Finale</button>
      </div>
    </nav>

    <section id="section-join" class="rounded-3xl border border-white/15 bg-white/5 p-6 shadow-xl">
      <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
        <div>
          <p class="text-xs uppercase tracking-[0.3em] text-btyYellow">Join checkpoint</p>
          <h2 class="text-2xl font-black text-white">Who is already on board?</h2>
          <p class="text-sm text-white/60">Refresh this after each welcome round so you know when to move on.</p>
        </div>
        <button class="scene-btn rounded-2xl border border-btyYellow bg-btyYellow/20 px-4 py-2 text-xs font-semibold uppercase tracking-[0.3em] text-btyYellow hover:bg-btyYellow/30" data-scene="join">Show join screen</button>
      </div>
      <div class="mt-6 grid gap-6 sm:grid-cols-3">
        <article class="rounded-3xl border border-white/10 bg-white/5 p-6 shadow-inner">
          <p class="text-xs uppercase tracking-[0.3em] text-white/60">Total participants</p>
          <p class="mt-2 text-4xl font-black text-white" id="snapshot-total">0</p>
        </article>
        <article class="rounded-3xl border border-white/10 bg-white/5 p-6 shadow-inner">
          <p class="text-xs uppercase tracking-[0.3em] text-white/60">Students</p>
          <p class="mt-2 text-4xl font-black text-white" id="snapshot-students">0</p>
        </article>
        <article class="rounded-3xl border border-white/10 bg-white/5 p-6 shadow-inner">
          <p class="text-xs uppercase tracking-[0.3em] text-white/60">Parents</p>
          <p class="mt-2 text-4xl font-black text-white" id="snapshot-parents">0</p>
        </article>
      </div>
    </section>

    <section id="section-feelings" class="rounded-3xl border border-white/15 bg-white/5 p-6 shadow-xl">
      <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
        <div>
          <p class="text-xs uppercase tracking-[0.3em] text-btyYellow">Feelings pulse</p>
          <h2 class="text-2xl font-black text-white">What the room hopes to feel</h2>
          <p class="text-sm text-white/60">Use these live inputs to connect programmes with values like discipline, adaptability, mindfulness, and resilience.</p>
        </div>
        <button class="scene-btn rounded-2xl border border-btyYellow bg-btyYellow/20 px-4 py-2 text-xs font-semibold uppercase tracking-[0.3em] text-btyYellow hover:bg-btyYellow/30" data-scene="pulse">Show pulse screen</button>
      </div>
      <div id="mood-summary" class="mt-6 grid gap-4 md:grid-cols-2"></div>
    </section>

    <section id="section-persona" class="rounded-3xl border border-white/15 bg-white/5 p-6 shadow-xl">
      <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
        <div>
          <p class="text-xs uppercase tracking-[0.3em] text-btyYellow">Persona spotlight</p>
          <h2 class="text-2xl font-black text-white">Who is surfacing in the room?</h2>
          <p class="text-sm text-white/60">Celebrate the dominant persona and acknowledge runner-ups when you reveal the spotlight on Stage.</p>
        </div>
        <button class="scene-btn rounded-2xl border border-btyYellow bg-btyYellow/20 px-4 py-2 text-xs font-semibold uppercase tracking-[0.3em] text-btyYellow hover:bg-btyYellow/30" data-scene="persona">Show persona spotlight</button>
      </div>
      <div id="persona-bars" class="mt-6 grid gap-4 md:grid-cols-2"></div>
      <article class="mt-6 space-y-3 rounded-3xl border border-white/15 bg-white/5 p-5">
        <p class="text-xs uppercase tracking-[0.3em] text-btyYellow">Stage preview</p>
        <p class="text-sm text-white/70">The Stage highlights the Imagine - Create - Explore pathways after the persona reveal. Cue the right story beats:</p>
        <ul class="list-disc space-y-1 pl-5 text-sm text-white/60">
          <li><span class="text-white">Imagine:</span> Applied Learning Programme, ML studios, NX101 labs.</li>
          <li><span class="text-white">Create:</span> DREAMS Concert, President's Challenge storytelling.</li>
          <li><span class="text-white">Explore:</span> NEXUS exchanges, e-Exchange with Estonia, industry attachments.</li>
        </ul>
      </article>
    </section>

    <section id="section-nexus" class="space-y-6 rounded-3xl border border-white/15 bg-white/5 p-6 shadow-xl">
      <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
        <div>
          <p class="text-xs uppercase tracking-[0.3em] text-btyYellow">NEXUS / Imagine • Create • Explore</p>
          <h2 class="text-2xl font-black text-white">Showcase moments</h2>
          <p class="text-sm text-white/60">Use this space to line up media cues and the stories you want to emphasise. More assets can slot in here later.</p>
        </div>
        <button class="scene-btn rounded-2xl border border-btyYellow bg-btyYellow/20 px-4 py-2 text-xs font-semibold uppercase tracking-[0.3em] text-btyYellow hover:bg-btyYellow/30" data-scene="tracks">Show Imagine • Create • Explore</button>
      </div>
      <div class="grid gap-6 lg:grid-cols-2">
        <article class="space-y-4 rounded-3xl border border-white/15 bg-white/5 p-5">
          <div>
            <p class="text-xs uppercase tracking-[0.3em] text-btyYellow">Media & spotlights</p>
            <h3 class="text-lg font-semibold text-white">Cue multimedia beats</h3>
            <ol class="mt-2 list-decimal space-y-1 pl-5 text-xs text-white/60">
              <li>Open the showcase with “What makes Beatty Secondary School truly special?”</li>
              <li>Use the BT70 Anniversary music video when celebrating arts and community spirit.</li>
              <li>Match your narration to the social proof highlight you trigger.</li>
            </ol>
          </div>
          <div class="grid gap-3 sm:grid-cols-2">
            <button class="media-btn rounded-2xl border border-white/25 px-4 py-2 text-xs font-semibold uppercase tracking-[0.3em] text-white/80 hover:bg-white/10" data-id="corporate" data-title="What makes Beatty Secondary School truly special?" data-url="https://www.youtube.com/embed/6xpckUCGIlE?rel=0&modestbranding=1">Play "What makes Beatty..."</button>
            <button class="media-btn rounded-2xl border border-white/25 px-4 py-2 text-xs font-semibold uppercase tracking-[0.3em] text-white/80 hover:bg-white/10" data-id="collaboration" data-title="BT70 Anniversary Music Video" data-url="https://www.youtube.com/embed/qp-OKBmFdA8?rel=0&modestbranding=1">Play "BT70 Anniversary"</button>
            <button id="stop-media" class="rounded-2xl border border-white/25 px-4 py-2 text-xs font-semibold uppercase tracking-[0.3em] text-white/80 hover:bg-white/10">Stop media</button>
          </div>
        </article>
        <article class="space-y-3 rounded-3xl border border-white/15 bg-white/5 p-5">
          <p class="text-xs uppercase tracking-[0.3em] text-btyYellow">Social proof spotlight</p>
          <p class="text-sm text-white/70">Mirror the story on Stage by selecting a highlight below.</p>
          <div class="flex flex-wrap gap-2" id="social-buttons">
            <button class="social-btn rounded-2xl border border-white/20 px-4 py-2 text-xs font-semibold uppercase tracking-[0.3em] text-white/80 hover:border-btyYellow hover:text-white" data-id="cross-disciplinary">Cross-disciplinary story</button>
            <button class="social-btn rounded-2xl border border-white/20 px-4 py-2 text-xs font-semibold uppercase tracking-[0.3em] text-white/80 hover:border-btyYellow hover:text-white" data-id="estonia-exchange">Estonia e-Exchange</button>
            <button class="social-btn rounded-2xl border border-white/20 px-4 py-2 text-xs font-semibold uppercase tracking-[0.3em] text-white/80 hover:border-btyYellow hover:text-white" data-id="nx101-critical">NX101 inquiry</button>
            <button class="social-btn rounded-2xl border border-white/20 px-4 py-2 text-xs font-semibold uppercase tracking-[0.3em] text-white/80 hover:border-btyYellow hover:text-white" data-id="football-champions">Football champions</button>
            <button class="social-btn rounded-2xl border border-white/20 px-4 py-2 text-xs font-semibold uppercase tracking-[0.3em] text-white/80 hover:border-btyYellow hover:text-white" data-id="dreams-concert">DREAMS concert</button>
            <button class="social-btn rounded-2xl border border-white/20 px-4 py-2 text-xs font-semibold uppercase tracking-[0.3em] text-white/80 hover:border-btyYellow hover:text-white" data-id="">Reset highlight</button>
          </div>
        </article>
      </div>
    </section>
    <section id="section-poll" class="space-y-4 rounded-3xl border border-white/15 bg-white/5 p-6 shadow-xl">
      <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
        <div>
          <p class="text-xs uppercase tracking-[0.3em] text-btyYellow">Poll controls</p>
          <h3 class="text-2xl font-black text-white">Run wow-factor poll</h3>
          <p class="text-sm text-white/60">Launch a preset or craft a custom question. Reveal the answer once the room has committed.</p>
        </div>
        <div class="grid gap-1 text-xs text-white/60">
          <button class="scene-btn rounded-2xl border border-btyYellow bg-btyYellow/20 px-4 py-2 text-xs font-semibold uppercase tracking-[0.3em] text-btyYellow hover:bg-btyYellow/30" data-scene="poll">Show poll on Stage</button>
          <p id="poll-status">No poll active.</p>
        </div>
      </div>
      <div id="poll-presets" class="grid gap-4 sm:grid-cols-2 xl:grid-cols-3">
        <article class="preset-card flex flex-col justify-between rounded-3xl border border-white/15 bg-white/5 p-4" data-preset="cca" data-answer="90%">
          <div class="space-y-2 text-xs text-white/70">
            <p class="uppercase tracking-[0.3em] text-btyYellow">Preset poll</p>
            <h4 class="text-sm font-semibold text-white">How many students get their 1st or 2nd choice CCA?</h4>
            <ul class="list-disc pl-4">
              <li>50%</li>
              <li>70%</li>
              <li>90%</li>
              <li>100%</li>
            </ul>
            <p class="text-[11px] text-btyYellow">Answer: 90%</p>
          </div>
          <button class="preset-launch mt-3 rounded-2xl border border-btyYellow bg-btyYellow/10 px-4 py-2 text-xs font-semibold uppercase tracking-[0.3em] text-btyYellow hover:bg-btyYellow/20">Launch poll</button>
        </article>
        <article class="preset-card flex flex-col justify-between rounded-3xl border border-white/15 bg-white/5 p-4" data-preset="g3jc" data-answer="90%">
          <div class="space-y-2 text-xs text-white/70">
            <p class="uppercase tracking-[0.3em] text-btyYellow">Preset poll</p>
            <h4 class="text-sm font-semibold text-white">What percentage of majority G3 students qualify for JC?</h4>
            <ul class="list-disc pl-4">
              <li>60%</li>
              <li>75%</li>
              <li>90%</li>
            </ul>
            <p class="text-[11px] text-btyYellow">Answer: 90%</p>
          </div>
          <button class="preset-launch mt-3 rounded-2xl border border-btyYellow bg-btyYellow/10 px-4 py-2 text-xs font-semibold uppercase tracking-[0.3em] text-btyYellow hover:bg-btyYellow/20">Launch poll</button>
        </article>
        <article class="preset-card flex flex-col justify-between rounded-3xl border border-white/15 bg-white/5 p-4" data-preset="g3poly" data-answer="99%">
          <div class="space-y-2 text-xs text-white/70">
            <p class="uppercase tracking-[0.3em] text-btyYellow">Preset poll</p>
            <h4 class="text-sm font-semibold text-white">What percentage of majority G3 students qualify for Poly?</h4>
            <ul class="list-disc pl-4">
              <li>70%</li>
              <li>85%</li>
              <li>99%</li>
            </ul>
            <p class="text-[11px] text-btyYellow">Answer: 99%</p>
          </div>
          <button class="preset-launch mt-3 rounded-2xl border border-btyYellow bg-btyYellow/10 px-4 py-2 text-xs font-semibold uppercase tracking-[0.3em] text-btyYellow hover:bg-btyYellow/20">Launch poll</button>
        </article>
        <article class="preset-card flex flex-col justify-between rounded-3xl border border-white/15 bg-white/5 p-4" data-preset="g2pfp" data-answer="25%">
          <div class="space-y-2 text-xs text-white/70">
            <p class="uppercase tracking-[0.3em] text-btyYellow">Preset poll</p>
            <h4 class="text-sm font-semibold text-white">What percentage of majority G2 students qualify for PFP?</h4>
            <ul class="list-disc pl-4">
              <li>10%</li>
              <li>25%</li>
              <li>40%</li>
            </ul>
            <p class="text-[11px] text-btyYellow">Answer: 25%</p>
          </div>
          <button class="preset-launch mt-3 rounded-2xl border border-btyYellow bg-btyYellow/10 px-4 py-2 text-xs font-semibold uppercase tracking-[0.3em] text-btyYellow hover:bg-btyYellow/20">Launch poll</button>
        </article>
        <article class="preset-card flex flex-col justify-between rounded-3xl border border-white/15 bg-white/5 p-4" data-preset="nexus" data-answer="50%">
          <div class="space-y-2 text-xs text-white/70">
            <p class="uppercase tracking-[0.3em] text-btyYellow">Preset poll</p>
            <h4 class="text-sm font-semibold text-white">What percentage of students join NEXUS 301/302 exchanges or attachments?</h4>
            <ul class="list-disc pl-4">
              <li>20%</li>
              <li>35%</li>
              <li>50%</li>
            </ul>
            <p class="text-[11px] text-btyYellow">Answer: 50%</p>
          </div>
          <button class="preset-launch mt-3 rounded-2xl border border-btyYellow bg-btyYellow/10 px-4 py-2 text-xs font-semibold uppercase tracking-[0.3em] text-btyYellow hover:bg-btyYellow/20">Launch poll</button>
        </article>
      </div>
      <div class="flex flex-wrap gap-3">
        <button id="reveal-poll" class="rounded-2xl border border-btyYellow bg-btyYellow/20 px-4 py-2 text-xs font-semibold uppercase tracking-[0.3em] text-btyYellow hover:bg-btyYellow/30">Reveal preset answer</button>
      </div>
      <div class="grid gap-3 sm:grid-cols-2">
        <label class="text-xs text-white/60">Custom question
          <input id="poll-question" class="mt-1 w-full rounded-2xl border border-white/20 bg-white/10 px-3 py-2 text-sm text-white focus:outline-none focus:ring-2 focus:ring-btyYellow" value="Which opportunity excites you most?" />
        </label>
        <div class="grid gap-2 text-xs text-white/60">
          <label>Option 1 <input id="opt1" class="mt-1 w-full rounded-2xl border border-white/20 bg-white/10 px-3 py-2 text-sm text-white focus:outline-none focus:ring-2 focus:ring-btyYellow" value="ALP: Machine Learning" /></label>
          <label>Option 2 <input id="opt2" class="mt-1 w-full rounded-2xl border border-white/20 bg-white/10 px-3 py-2 text-sm text-white focus:outline-none focus:ring-2 focus:ring-btyYellow" value="LLP: Leadership" /></label>
          <label>Option 3 <input id="opt3" class="mt-1 w-full rounded-2xl border border-white/20 bg-white/10 px-3 py-2 text-sm text-white focus:outline-none focus:ring-2 focus:ring-btyYellow" value="NEXUS@BTY exchanges" /></label>
          <label>Option 4 <input id="opt4" class="mt-1 w-full rounded-2xl border border-white/20 bg-white/10 px-3 py-2 text-sm text-white focus:outline-none focus:ring-2 focus:ring-btyYellow" value="CCA distinctions" /></label>
        </div>
      </div>
      <div class="flex flex-wrap gap-3">
        <button id="start-poll" class="rounded-2xl bg-btyBlue px-5 py-2 text-xs font-semibold uppercase tracking-[0.3em] text-white hover:bg-btyBlue/80">Start custom poll</button>
        <button id="stop-poll" class="rounded-2xl border border-white/25 px-5 py-2 text-xs font-semibold uppercase tracking-[0.3em] text-white/80 hover:bg-white/10">Stop poll</button>
      </div>
    </section>

    <section id="section-finale" class="rounded-3xl border border-white/15 bg-white/5 p-6 shadow-xl">
      <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
        <div>
          <p class="text-xs uppercase tracking-[0.3em] text-btyYellow">Finale & wrap-up</p>
          <h2 class="text-2xl font-black text-white">Close the loop with clarity</h2>
          <p class="text-sm text-white/60">When the poll reveal lands, cue the finale and invite everyone to pull up their Journey Cards.</p>
        </div>
        <button id="close-loop" class="rounded-2xl border border-btyYellow bg-btyYellow/20 px-4 py-2 text-xs font-semibold uppercase tracking-[0.3em] text-btyYellow hover:bg-btyYellow/30">Move Stage to finale</button>
      </div>
      <div class="mt-6 grid gap-6 lg:grid-cols-2">
        <article class="space-y-3 rounded-3xl border border-white/15 bg-white/5 p-5">
          <p class="text-xs uppercase tracking-[0.3em] text-btyYellow">Journey Cards</p>
          <p class="text-sm text-white/70">Download entries before you clear them. Each card helps the team follow up quickly.</p>
          <div class="flex flex-wrap gap-3">
            <button id="download-journey" class="rounded-2xl border border-white/25 px-4 py-2 text-xs font-semibold uppercase tracking-[0.3em] text-white/80 hover:bg-white/10">Download log</button>
            <button id="clear-journey" class="rounded-2xl border border-white/25 px-4 py-2 text-xs font-semibold uppercase tracking-[0.3em] text-white/80 hover:bg-white/10">Clear log</button>
          </div>
          <p id="journey-status" class="text-xs text-white/60">Log stored at data/journey_submissions.jsonl.</p>
        </article>
        <article class="space-y-3 rounded-3xl border border-white/15 bg-white/5 p-5">
          <p class="text-xs uppercase tracking-[0.3em] text-btyYellow">Tech ops</p>
          <p class="text-sm text-white/70">Send quick pings during transitions so the AV crew stays aligned.</p>
          <div class="grid gap-3 sm:grid-cols-2">
            <button id="ping-audio" class="rounded-2xl border border-white/25 px-4 py-2 text-xs font-semibold uppercase tracking-[0.3em] text-white/80 hover:bg-white/10">Ping stage (Audio check)</button>
            <button id="ping-visual" class="rounded-2xl border border-white/25 px-4 py-2 text-xs font-semibold uppercase tracking-[0.3em] text-white/80 hover:bg-white/10">Ping stage (Visual check)</button>
            <button id="reset-social" class="rounded-2xl border border-white/25 px-4 py-2 text-xs font-semibold uppercase tracking-[0.3em] text-white/80 hover:bg-white/10">Reset social highlight</button>
            <button class="scene-btn rounded-2xl border border-white/25 px-4 py-2 text-xs font-semibold uppercase tracking-[0.3em] text-white/80 hover:bg-white/10" data-scene="social">Show social carousel</button>
          </div>
          <p id="ops-status" class="text-xs text-white/60">No tech pings yet.</p>
        </article>
      </div>
    </section>
  </main>

  <script src="/app.js"></script>
  <script>
    const currentScene = document.getElementById('current-scene');
    const timelineStatus = document.getElementById('timeline-status');
    const snapshotTotal = document.getElementById('snapshot-total');
    const snapshotStudents = document.getElementById('snapshot-students');
    const snapshotParents = document.getElementById('snapshot-parents');
    const journeyCount = document.getElementById('journey-count');
    const pollStatus = document.getElementById('poll-status');
    const personaBars = document.getElementById('persona-bars');
    const moodSummary = document.getElementById('mood-summary');
    const opsStatus = document.getElementById('ops-status');
    const downloadJourneyBtn = document.getElementById('download-journey');
    const clearJourneyBtn = document.getElementById('clear-journey');
    const journeyStatus = document.getElementById('journey-status');
    const pollQuestionInput = document.getElementById('poll-question');
    const optInputs = [document.getElementById('opt1'), document.getElementById('opt2'), document.getElementById('opt3'), document.getElementById('opt4')];
    let activePresetButton = null;

    document.querySelectorAll('.jump-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const target = document.getElementById(btn.dataset.target);
        if (target) target.scrollIntoView({ behavior: 'smooth', block: 'start' });
      });
    });

    document.querySelectorAll('.scene-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        API.send('scene', { scene: btn.dataset.scene });
      });
    });

    document.querySelectorAll('.media-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        API.send('media:play', { id: btn.dataset.id, title: btn.dataset.title, url: btn.dataset.url });
      });
    });

    document.getElementById('stop-media').addEventListener('click', () => API.send('media:stop', {}));

    document.querySelectorAll('.social-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        API.send('social:feature', { id: btn.dataset.id || null });
      });
    });

    const PRESETS = {
      cca: { q: 'How many students get their 1st or 2nd choice CCA?', opts: ['50%', '70%', '90%', '100%'], answer: '90%' },
      g3jc: { q: 'What percentage of majority G3 students qualify for JC?', opts: ['60%', '75%', '90%'], answer: '90%' },
      g3poly: { q: 'What percentage of majority G3 students qualify for Poly?', opts: ['70%', '85%', '99%'], answer: '99%' },
      g2pfp: { q: 'What percentage of majority G2 students qualify for PFP?', opts: ['10%', '25%', '40%'], answer: '25%' },
      nexus: { q: 'What percentage of students participate in NEXUS 301/302 (International Exchange / Industry Attachment)?', opts: ['20%', '35%', '50%'], answer: '50%' }
    };

    document.querySelectorAll('.preset-launch').forEach(btn => {
      btn.addEventListener('click', () => {
        const card = btn.closest('.preset-card');
        const preset = PRESETS[card?.dataset.preset || btn.dataset.preset];
        if (!preset) return;
        pollQuestionInput.value = preset.q;
        preset.opts.forEach((opt, idx) => {
          if (optInputs[idx]) optInputs[idx].value = opt;
        });
        API.send('scene', { scene: 'poll' });
        const options = preset.opts.map((label, idx) => ({ id: idx + 1, label }));
        API.send('poll:start', { id: Date.now(), question: preset.q, options, durationMs: 20000 });
        if (activePresetButton) {
          activePresetButton.classList.remove('ring-2', 'ring-btyYellow');
          activePresetButton.closest('.preset-card')?.classList.remove('ring-2', 'ring-btyYellow');
        }
        activePresetButton = btn;
        btn.classList.add('ring-2', 'ring-btyYellow');
        card?.classList.add('ring-2', 'ring-btyYellow');
        btn.dataset.answer = preset.answer;
        pollStatus.textContent = `Live poll: ${preset.q}`;
      });
    });

    document.getElementById('reveal-poll').addEventListener('click', () => {
      const answer = activePresetButton?.dataset.answer || activePresetButton?.closest('.preset-card')?.dataset.answer || '';
      API.send('poll:reveal', { answerText: answer ? `Correct: ${answer}` : 'Check the official answer.' });
      if (answer) {
        pollStatus.textContent = `Revealed answer: ${answer}`;
      }
    });

    document.getElementById('start-poll').addEventListener('click', () => {
      const opts = optInputs.map((input, idx) => input.value).filter(Boolean).map((label, idx) => ({ id: idx + 1, label }));
      API.send('scene', { scene: 'poll' });
      API.send('poll:start', { id: Date.now(), question: pollQuestionInput.value, options: opts, durationMs: 20000 });
      pollStatus.textContent = `Live poll: ${pollQuestionInput.value}`;
      if (activePresetButton) {
        activePresetButton.classList.remove('ring-2', 'ring-btyYellow');
        activePresetButton.closest('.preset-card')?.classList.remove('ring-2', 'ring-btyYellow');
        activePresetButton = null;
      }
    });

    document.getElementById('stop-poll').addEventListener('click', () => {
      API.send('poll:stop', {});
      pollStatus.textContent = 'Poll stopped.';
      if (activePresetButton) {
        activePresetButton.classList.remove('ring-2', 'ring-btyYellow');
        activePresetButton.closest('.preset-card')?.classList.remove('ring-2', 'ring-btyYellow');
        activePresetButton = null;
      }
    });

    const MOODS = [
      { id: 'curiosity', label: 'Curiosity' },
      { id: 'confidence', label: 'Confidence' },
      { id: 'belonging', label: 'Belonging' },
      { id: 'joy', label: 'Joy' },
      { id: 'purpose', label: 'Purpose' },
      { id: 'growth', label: 'Growth' },
      { id: 'focused', label: 'Focused Discipline' },
      { id: 'adaptable', label: 'Adaptable Spirit' },
      { id: 'mindful', label: 'Calm & Mindful' },
      { id: 'resilient', label: 'Resilient Heart' }
    ];

    const moodCounts = Object.fromEntries(MOODS.map(m => [m.id, 0]));

    function renderMoodSummary() {
      const total = Object.values(moodCounts).reduce((acc, val) => acc + val, 0) || 1;
      moodSummary.innerHTML = MOODS.map(mood => {
        const count = moodCounts[mood.id] || 0;
        const pct = Math.round((count / total) * 100);
        return `
          <div class="rounded-3xl border border-white/10 bg-white/5 p-4">
            <div class="flex items-center justify-between text-sm text-white/70">
              <span class="font-semibold text-white">${mood.label}</span>
              <span>${count}</span>
            </div>
            <div class="mt-2 h-2 w-full overflow-hidden rounded-full bg-white/10">
              <div class="h-full rounded-full bg-gradient-to-r from-btyRed via-btyYellow to-white" style="width:${pct}%"></div>
            </div>
            <p class="mt-2 text-xs uppercase tracking-[0.2em] text-white/50">${pct}% of picks</p>
          </div>`;
      }).join('');
    }

    renderMoodSummary();

    document.getElementById('ping-audio').addEventListener('click', () => {
      API.send('ops:ping', { note: 'Audio check' });
      opsStatus.textContent = 'Audio check ping sent to Stage.';
    });
    document.getElementById('ping-visual').addEventListener('click', () => {
      API.send('ops:ping', { note: 'Visual check' });
      opsStatus.textContent = 'Visual check ping sent to Stage.';
    });
    document.getElementById('reset-social').addEventListener('click', () => {
      API.send('social:feature', { id: null });
      opsStatus.textContent = 'Social highlight reset.';
    });
    document.getElementById('close-loop').addEventListener('click', () => {
      API.send('scene', { scene: 'finale' });
      pollStatus.textContent = 'Jumped to finale.';
    });

    downloadJourneyBtn.addEventListener('click', async () => {
      journeyStatus.textContent = 'Preparing download...';
      try {
        const res = await fetch('/journey');
        if (!res.ok) throw new Error('Request failed');
        const entries = await res.json();
        const blob = new Blob([JSON.stringify(entries, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `journey-log-${Date.now()}.json`;
        a.click();
        URL.revokeObjectURL(url);
        journeyStatus.textContent = `Downloaded ${entries.length} entr${entries.length === 1 ? 'y' : 'ies'}.`;
      } catch (err) {
        journeyStatus.textContent = 'Download failed. Please try again.';
      }
    });

    clearJourneyBtn.addEventListener('click', async () => {
      journeyStatus.textContent = 'Clearing log...';
      try {
        const res = await fetch('/journey/clear', { method: 'POST' });
        if (!res.ok) throw new Error('Request failed');
        journeyStatus.textContent = 'Journey log cleared.';
      } catch (err) {
        journeyStatus.textContent = 'Could not clear log right now.';
      }
    });

    function renderPersonaMix(personas) {
      const total = Object.values(personas).reduce((acc, val) => acc + val, 0) || 1;
      personaBars.innerHTML = Object.entries(personas).map(([key, count]) => {
        const pct = Math.round((count / total) * 100);
        const label = key.charAt(0).toUpperCase() + key.slice(1);
        return `
          <div class="rounded-3xl border border-white/10 bg-white/5 p-4">
            <div class="flex items-center justify-between text-sm text-white/70">
              <span class="font-semibold text-white">${label}</span>
              <span>${count}</span>
            </div>
            <div class="mt-2 h-2 w-full overflow-hidden rounded-full bg-white/10">
              <div class="h-full rounded-full bg-gradient-to-r from-btyBlue via-btyYellow to-btyRed" style="width:${pct}%"></div>
            </div>
            <p class="mt-2 text-xs uppercase tracking-[0.2em] text-white/50">${pct}% of votes</p>
          </div>`;
      }).join('');
    }

    API.onEvent((type, data) => {
      if (type === 'scene') {
        currentScene.textContent = data.scene;
      }

      if (type === 'timeline:status') {
        if (data.active) {
          timelineStatus.textContent = `Running - ${data.label}`;
        } else {
          timelineStatus.textContent = data.label || 'Manual control active.';
        }
      }

      if (type === 'join') {
        snapshotTotal.textContent = data.audienceCounts?.total || 0;
        snapshotStudents.textContent = data.audienceCounts?.students || 0;
        snapshotParents.textContent = data.audienceCounts?.parents || 0;
      }

      if (type === 'mood') {
        const id = data.id;
        if (id && Object.prototype.hasOwnProperty.call(moodCounts, id)) {
          moodCounts[id] += 1;
          renderMoodSummary();
        }
      }

      if (type === 'persona') {
        if (data.personaCounts) {
          renderPersonaMix(data.personaCounts);
        }
      }

      if (type === 'init') {
        snapshotTotal.textContent = data.audienceCounts?.total || 0;
        snapshotStudents.textContent = data.audienceCounts?.students || 0;
        snapshotParents.textContent = data.audienceCounts?.parents || 0;
        currentScene.textContent = data.scene || 'join';
        if (data.timeline) {
          timelineStatus.textContent = data.timeline.active ? `Running - ${data.timeline.label}` : (data.timeline.label || 'Manual control active.');
        }
        if (data.personaCounts) renderPersonaMix(data.personaCounts);
        const initialJourney = data.journeyCount || 0;
        journeyCount.textContent = initialJourney;
        journeyStatus.textContent = `Journey cards saved: ${initialJourney}`;
      }

      if (type === 'journey:summary') {
        const count = data.count || 0;
        journeyCount.textContent = count;
        journeyStatus.textContent = `Journey cards saved: ${count}`;
      }

      if (type === 'poll:start') {
        pollStatus.textContent = `Live poll: ${data.question}`;
      }

      if (type === 'poll:stop') {
        pollStatus.textContent = 'Poll stopped.';
        if (activePresetButton) {
          activePresetButton.classList.remove('ring-2', 'ring-btyYellow');
          activePresetButton.closest('.preset-card')?.classList.remove('ring-2', 'ring-btyYellow');
          activePresetButton = null;
        }
      }

      if (type === 'poll:reveal') {
        pollStatus.textContent = data?.answerText ? `Answer revealed: ${data.answerText}` : 'Answer revealed.';
        if (activePresetButton) {
          activePresetButton.classList.remove('ring-2', 'ring-btyYellow');
          activePresetButton.closest('.preset-card')?.classList.remove('ring-2', 'ring-btyYellow');
          activePresetButton = null;
        }
      }

      if (type === 'ops:ping') {
        opsStatus.textContent = `${data.note} confirmed at ${new Date(data.ts).toLocaleTimeString()}`;
      }
    });
  </script>
</body>
</html>
