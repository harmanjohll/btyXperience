<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Beatty Stageboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            btyBlue: '#000C53',
            btyYellow: '#FFE200',
            btyRed: '#EC3237',
            midnight: '#070B24',
            moon: '#E9ECFF'
          },
          fontFamily: {
            sans: ['Lato', 'ui-sans-serif', 'system-ui']
          }
        }
      }
    };
  </script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;600;700;900&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="/styles.css" />
</head>
<body class="min-h-screen font-sans text-moon">
  <div id="timeline-badge" class="fixed right-6 top-6 z-40 flex w-64 items-center gap-3 rounded-full border border-white/20 bg-white/10 px-5 py-3 backdrop-blur-md">
    <span id="timeline-dot" class="h-3 w-3 rounded-full bg-btyYellow shadow-[0_0_12px_rgba(255,226,0,0.8)]"></span>
    <div>
      <p id="timeline-label" class="text-xs uppercase tracking-[0.3em] text-btyYellow">Flow idle</p>
      <p id="timeline-text" class="text-sm text-white/80">Ready for take-off.</p>
    </div>
  </div>

  <main class="relative mx-auto flex max-w-6xl flex-col gap-10 px-6 py-12">
    <header class="flex flex-col gap-4 rounded-3xl border border-white/10 bg-white/5/30 p-6 backdrop-blur-lg lg:flex-row lg:items-center lg:justify-between">
      <div class="flex items-center gap-4">
        <img src="/content/assets/BTlogo.png" class="h-16 w-16 rounded-full border border-white/30 bg-white/20 p-2" alt="Beatty logo" />
        <div>
          <p class="text-xs uppercase tracking-[0.3em] text-btyYellow">Beatty Secondary School</p>
          <h1 class="text-3xl font-black text-white sm:text-4xl">Where Your Aspirations Take Flight</h1>
          <p class="text-sm text-white/70">Mission: Adaptive Thinkers, Agile Learners &amp; Active Contributors &bull; Vision: Every Beattyian a Purpose-driven Steward &bull; Values: DREAM (Discipline, Resilience, Empathy, Adaptability, Mindfulness)</p>
        </div>
      </div>
      <div class="flex flex-wrap gap-3 text-xs text-white/70">
        <span class="rounded-full border border-white/20 px-4 py-1">Motto: Non Vi Sed Arte (Not with force but with skill)</span>
        <span class="rounded-full border border-white/20 px-4 py-1">Applied Learning Programme: Machine Learning &amp; Design Thinking</span>
        <span class="rounded-full border border-white/20 px-4 py-1">Learning for Life Programme: Leadership (SHARP &amp; KP Challenges)</span>
      </div>
    </header>

    <section id="scene-join" class="scene grid grid-cols-1 gap-8 lg:grid-cols-[1.2fr_0.8fr]">
      <div class="relative overflow-hidden rounded-3xl border border-white/10 bg-white/10 p-10 shadow-2xl">
        <img src="/content/assets/photos/Nur_Riana.jpg" class="absolute inset-0 h-full w-full object-cover opacity-50" alt="Student leader" />
        <div class="relative flex h-full flex-col justify-end gap-4">
          <p class="inline-flex w-fit items-center gap-2 rounded-full bg-btyYellow/90 px-4 py-1 text-sm font-semibold text-btyBlue">Belief &bull; Every student has latent gifts ready to shine</p>
          <h2 class="text-4xl font-black text-white sm:text-5xl">Step into the Beatty experience</h2>
          <p class="text-lg text-white/85">Scan in, tell us how you love to learn, and co-create today&#39;s story with us.</p>
        </div>
      </div>
      <div class="flex flex-col justify-between gap-6 rounded-3xl border border-white/10 bg-white/5 p-8">
        <div>
          <h3 class="text-xl font-bold text-white">Join from your phone</h3>
          <p class="mt-2 text-sm text-white/70">On your device open <strong id="connect-url" class="font-semibold text-btyYellow"></strong> or scan the QR code.</p>
          <div class="mt-6 flex items-center gap-6">
            <div id="qrcode" class="h-32 w-32 rounded-2xl border border-white/20 bg-white/70 p-2"></div>
            <ul class="space-y-2 text-sm text-white/70">
              <li>&bull; Same Wi-Fi network as the presenter</li>
              <li>&bull; No app install required</li>
              <li>&bull; Share your role and top interests</li>
            </ul>
          </div>
        </div>
        <div class="rounded-2xl border border-white/20 bg-white/5 p-5">
          <p class="text-sm font-semibold uppercase tracking-[0.2em] text-btyYellow">Who&#39;s already aboard</p>
          <div class="mt-4 flex flex-wrap gap-3" id="audience-pills">
            <span class="rounded-full bg-white/10 px-4 py-2 text-sm">Total: <span id="count-total">0</span></span>
            <span class="rounded-full bg-white/10 px-4 py-2 text-sm">Students: <span id="count-stu">0</span></span>
            <span class="rounded-full bg-white/10 px-4 py-2 text-sm">Parents: <span id="count-par">0</span></span>
          </div>
          <p class="mt-4 text-sm text-white/60">Top interests in the room</p>
          <div id="top-interests" class="mt-2 flex flex-wrap gap-2 text-xs text-white/80"></div>
        </div>
      </div>
    </section>

    <section id="scene-pulse" class="scene hidden">
      <div class="grid gap-6 lg:grid-cols-[1.1fr_0.9fr]">
        <div class="relative overflow-hidden rounded-3xl border border-white/10 bg-white/10 p-10 shadow-2xl">
          <img src="/content/assets/photos/Nexus_Internalisation_Programme.png" class="absolute inset-0 h-full w-full object-cover opacity-40" alt="NEXUS experience" />
          <div class="relative flex h-full flex-col justify-end gap-4">
            <p class="inline-flex w-fit items-center gap-2 rounded-full bg-white/20 px-4 py-1 text-sm font-semibold text-white">Feel the room</p>
            <h2 class="text-4xl font-black text-white">What feeling do you want more of in secondary school?</h2>
            <p class="text-lg text-white/80">Tap on Passport and watch the mood ripple across the hall.</p>
          </div>
        </div>
        <div class="rounded-3xl border border-white/10 bg-white/5 p-6">
          <div id="mood-grid" class="grid gap-4 sm:grid-cols-2"></div>
        </div>
      </div>
    </section>

    <section id="scene-persona" class="scene hidden">
      <div class="grid gap-6 lg:grid-cols-[1.1fr_0.9fr]">
        <div class="relative overflow-hidden rounded-3xl border border-white/10 bg-white/10 p-10 shadow-2xl">
          <img src="/content/assets/photos/LLP_Dept_Highlights.png" class="absolute inset-0 h-full w-full object-cover opacity-40" alt="Leadership highlights" />
          <div class="relative flex h-full flex-col justify-end gap-4">
            <p class="inline-flex w-fit items-center gap-2 rounded-full bg-white/20 px-4 py-1 text-sm font-semibold text-white">Persona spotlight</p>
            <h2 class="text-4xl font-black text-white">When challenge appears, who are you?</h2>
            <p class="text-lg text-white/80">Explorer, Creator, Guardian, Trailblazer &mdash; each opens gateways at Beatty.</p>
          </div>
        </div>
        <div class="rounded-3xl border border-white/10 bg-white/5 p-6">
          <div id="persona-grid" class="grid gap-4 sm:grid-cols-2"></div>
        </div>
      </div>
    </section>

    <section id="scene-tracks" class="scene hidden">
      <div class="rounded-3xl border border-white/10 bg-white/5 p-8">
        <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
          <div>
            <p class="text-sm uppercase tracking-[0.3em] text-btyYellow">Choose your Beatty track</p>
            <h2 class="text-3xl font-black text-white">Imagine &bull; Create &bull; Explore</h2>
            <p class="text-white/70">Each track features authentic projects, industry partners, and mentors.</p>
          </div>
          <p class="text-xs text-white/50">Presenter tip: cue videos from the console when introducing each track.</p>
        </div>
        <div id="track-grid" class="mt-6 grid gap-5 md:grid-cols-3"></div>
      </div>
    </section>

    <section id="scene-recommend" class="scene hidden">
      <div class="rounded-3xl border border-white/10 bg-white/5 p-8">
        <p class="text-sm uppercase tracking-[0.3em] text-btyYellow">Matched opportunities</p>
        <h2 class="text-3xl font-black text-white">Programmes aligned with today&#39;s personas</h2>
        <p class="text-white/70">Powered by machine learning studios, leadership challenges, NEXUS spirals, and value-added CCAs.</p>
        <div id="recommend-grid" class="mt-6 grid gap-5 md:grid-cols-4"></div>
      </div>
    </section>

    <section id="scene-social" class="scene hidden">
      <div class="rounded-3xl border border-white/10 bg-white/5 p-8">
        <div class="flex flex-col gap-2 sm:flex-row sm:items-end sm:justify-between">
          <div>
            <p class="text-sm uppercase tracking-[0.3em] text-btyYellow">Beatty in action</p>
            <h2 class="text-3xl font-black text-white">Latest highlights from our community</h2>
            <p class="text-white/70">Stories from official channels &mdash; values in action, talent on stage, teams achieving distinctions.</p>
          </div>
          <p id="social-source" class="text-sm text-white/50"></p>
        </div>
        <div id="social-grid" class="mt-6 grid gap-6 md:grid-cols-3"></div>
      </div>
    </section>

    <section id="scene-poll" class="scene hidden">
      <div class="grid gap-6 lg:grid-cols-[1.1fr_0.9fr]">
        <div class="relative overflow-hidden rounded-3xl border border-white/10 bg-white/10 p-10 shadow-2xl">
          <img src="/content/assets/photos/Caden_Goh.jpg" class="absolute inset-0 h-full w-full object-cover opacity-40" alt="Achievement" />
          <div class="relative flex h-full flex-col justify-end gap-4">
            <p class="inline-flex w-fit items-center gap-2 rounded-full bg-white/20 px-4 py-1 text-sm font-semibold text-white">Live pulse</p>
            <h2 id="poll-question" class="text-4xl font-black text-white">Have your say</h2>
            <p class="text-lg text-white/80">You will see how expectations compare with Beatty&#39;s performance.</p>
          </div>
        </div>
        <div class="rounded-3xl border border-white/10 bg-white/5 p-6">
          <div id="poll-results" class="grid gap-4 sm:grid-cols-2"></div>
          <div id="reveal" class="mt-6 hidden rounded-2xl border border-btyYellow/50 bg-btyYellow/10 px-5 py-4 text-btyYellow">
            <p class="text-sm font-semibold">Answer: <span id="reveal-text"></span></p>
          </div>
        </div>
      </div>
    </section>

    <section id="scene-finale" class="scene hidden">
      <div class="grid gap-6 lg:grid-cols-[1.1fr_0.9fr]">
        <div class="relative overflow-hidden rounded-3xl border border-white/10 bg-white/10 p-10 shadow-2xl">
          <img src="/content/assets/photos/Nexus_3011_3012.png" class="absolute inset-0 h-full w-full object-cover opacity-40" alt="International exchange" />
          <div class="relative flex h-full flex-col justify-end gap-4">
            <p class="inline-flex w-fit items-center gap-2 rounded-full bg-white/20 px-4 py-1 text-sm font-semibold text-white">Your journey, our community</p>
            <h2 class="text-4xl font-black text-white">Take your next step with Beatty</h2>
            <p class="text-lg text-white/80">Journeys continue after today: connect with our teachers, students, and programmes.</p>
          </div>
        </div>
        <div class="rounded-3xl border border-white/10 bg-white/5 p-6">
          <h3 class="text-xl font-bold text-white">Highlights to remember</h3>
          <ul class="mt-4 space-y-3 text-sm text-white/75">
            <li>&bull; ALP: Machine Learning &amp; Design Thinking studio with industry mentors</li>
            <li>&bull; LLP: Leadership journeys (SHARP, KP challenge, community service)</li>
            <li>&bull; NEXUS@BTY: Sec 3 pathways &mdash; international exchanges and industry apprenticeships</li>
            <li>&bull; CCAs: Uniformed Groups distinctions, Football champs, vibrant arts and media</li>
          </ul>
          <a href="https://www.figma.com/proto/VuQQTLE8GDlNoyBdEsUIUJ/Beatty-Secondary-School---Prospectus?node-id=134-688&t=vFKHSXqf0oXdbj58-1" target="_blank" rel="noopener" class="mt-4 inline-flex items-center gap-2 rounded-full border border-btyYellow bg-btyYellow/20 px-4 py-2 text-xs font-semibold uppercase tracking-[0.3em] text-btyYellow hover:bg-btyYellow/30">View Prospectus</a>
          <p class="mt-6 text-sm text-white/60">Ask for your Journey Card at the exit or scan to book a follow-up conversation.</p>
        </div>
      </div>
    </section>
  </main>

  <div id="media-overlay" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/70 p-6">
    <div class="w-full max-w-4xl rounded-3xl bg-midnight p-6 shadow-2xl">
      <div class="mb-4 flex items-center justify-between">
        <h3 id="media-title" class="text-xl font-bold text-white">Media cue</h3>
        <button id="media-close" class="text-sm text-white/70 hover:text-white">Close</button>
      </div>
      <div class="aspect-video w-full overflow-hidden rounded-2xl border border-white/10 bg-black">
        <iframe id="media-frame" class="h-full w-full" src="" title="Beatty video" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
      </div>
    </div>
  </div>

  <script src="/qrcode.min.js"></script>
  <script src="/app.js"></script>
  <script>
    const scenes = {
      join: document.getElementById('scene-join'),
      pulse: document.getElementById('scene-pulse'),
      persona: document.getElementById('scene-persona'),
      tracks: document.getElementById('scene-tracks'),
      recommend: document.getElementById('scene-recommend'),
      social: document.getElementById('scene-social'),
      poll: document.getElementById('scene-poll'),
      finale: document.getElementById('scene-finale')
    };

    const connectUrl = document.getElementById('connect-url');
    const countTotal = document.getElementById('count-total');
    const countStu = document.getElementById('count-stu');
    const countPar = document.getElementById('count-par');
    const topInterests = document.getElementById('top-interests');
    const moodGrid = document.getElementById('mood-grid');
    const personaGrid = document.getElementById('persona-grid');
    const trackGrid = document.getElementById('track-grid');
    const recommendGrid = document.getElementById('recommend-grid');
    const pollQuestion = document.getElementById('poll-question');
    const pollResults = document.getElementById('poll-results');
    const revealBox = document.getElementById('reveal');
    const revealText = document.getElementById('reveal-text');
    const socialGrid = document.getElementById('social-grid');
    const socialSource = document.getElementById('social-source');
    const badgeLabel = document.getElementById('timeline-label');
    const badgeText = document.getElementById('timeline-text');
    const badgeDot = document.getElementById('timeline-dot');

    const mediaOverlay = document.getElementById('media-overlay');
    const mediaFrame = document.getElementById('media-frame');
    const mediaTitle = document.getElementById('media-title');
    document.getElementById('media-close').addEventListener('click', () => {
      window.API.send('media:stop', {});
    });

    const MOODS = [
      { id: 'curiosity', label: 'Curiosity' },
      { id: 'confidence', label: 'Confidence' },
      { id: 'belonging', label: 'Belonging' },
      { id: 'joy', label: 'Joy' },
      { id: 'purpose', label: 'Purpose' },
      { id: 'growth', label: 'Growth' }
    ];

    const PERSONAS = {
      explorer: { label: 'Explorer', tie: 'NEXUS expeditions &amp; AI immersions' },
      creator: { label: 'Creator', tie: 'ALP makers, DREAMS concert' },
      guardian: { label: 'Guardian', tie: 'LLP leadership &amp; community service' },
      trailblazer: { label: 'Trailblazer', tie: 'Academic stretch &amp; industry attachments' }
    };

    const TRACKS = [
      { key: 'imagine', title: 'Imagine', subtitle: 'Design the future', description: 'Co-create cross-disciplinary solutions in ALP labs and NX101 Critical Cornerstones projects.', persona: 'creator', image: '/content/assets/photos/ALP_Dept_Highlights.png' },
      { key: 'create', title: 'Create', subtitle: 'Lead with heart', description: 'Stage the DREAMS concert, champion President’s Challenge causes, and grow Beatty’s culture.', persona: 'guardian', image: '/content/assets/photos/LLP_Dept_Highlights.png' },
      { key: 'explore', title: 'Explore', subtitle: 'Go beyond Singapore', description: 'Travel on NEXUS experiences like the Estonia e-Exchange and overseas industry attachments.', persona: 'explorer', image: '/content/assets/photos/Nexus_Internalisation_Programme.png' }
    ];

    const SOCIAL_POSTS = [
      {
        id: 'cross-disciplinary',
        title: 'Cross-Disciplinary Learning in Action',
        copy: 'Students integrate Geography, Mathematics, and ALP design thinking to solve real-world challenges, demonstrating the Beatty belief in active contributors.',
        source: 'Facebook • Curriculum spotlight',
        link: 'https://www.facebook.com/share/p/17A23PpFWE/',
        image: '/content/assets/photos/LLP_Dept_Highlights.png'
      },
      {
        id: 'estonia-exchange',
        title: 'Estonia e-Exchange',
        copy: 'Beattyians collaborate with peers in Estonia, exploring digital citizenship and global perspectives—proof that learning travels beyond Singapore.',
        source: 'Facebook • International experience',
        link: 'https://www.facebook.com/share/p/1FvYFpzQov/',
        image: '/content/assets/photos/Nexus_Internalisation_Programme.png'
      },
      {
        id: 'nx101-critical',
        title: 'NX101: Critical Cornerstones',
        copy: 'Our Critical Inquiry project (Geography x Mathematics x ALP) grows inquisitive minds who apply data and design to community issues.',
        source: 'Facebook • Nexus spotlight',
        link: 'https://www.facebook.com/share/p/175FmBcFLw/',
        image: '/content/assets/photos/ALP_Dept_Highlights.png'
      },
      {
        id: 'football-champions',
        title: 'League 3 Football Champions',
        copy: 'Both divisions clinched the League 3 football titles, showcasing discipline, resilience, and teamwork on the pitch.',
        source: 'Facebook • CCA highlight',
        link: 'https://www.facebook.com/share/p/17QdgEFnEF/',
        image: '/content/assets/photos/Caden_Goh.jpg'
      },
      {
        id: 'dreams-concert',
        title: 'DREAMS Concert for President’s Challenge',
        copy: 'Performing arts talents come together to raise funds for the President’s Challenge—Beattyians leading with empathy and purpose.',
        source: 'Facebook • Active contributor',
        link: 'https://www.facebook.com/share/p/1Nq15byVpY/',
        image: '/content/assets/photos/LLP_Dept_Highlights.png'
      }
    ];

    const moodCounts = Object.fromEntries(MOODS.map(m => [m.id, 0]));
    const stageState = {
      scene: 'join',
      audience: { total: 0, students: 0, parents: 0 },
      interests: {},
      poll: null,
      personaCounts: { explorer: 0, creator: 0, guardian: 0, trailblazer: 0 },
      socialFeature: null,
      timeline: { active: false, label: 'Idle' }
    };

    connectUrl.textContent = `${window.location.origin}/passport`;

    function setScene(name) {
      stageState.scene = name;
      Object.values(scenes).forEach(section => section.classList.add('hidden'));
      if (scenes[name]) scenes[name].classList.remove('hidden');
    }

    function renderCounts() {
      countTotal.textContent = stageState.audience.total || 0;
      countStu.textContent = stageState.audience.students || 0;
      countPar.textContent = stageState.audience.parents || 0;
      const entries = Object.entries(stageState.interests || {}).sort((a,b)=>b[1]-a[1]).slice(0,6);
      if (!entries.length) {
        topInterests.innerHTML = '<span class="rounded-full border border-white/20 px-3 py-1">Tap interests on Passport to see them here.</span>';
      } else {
        topInterests.innerHTML = entries.map(([tag,count]) => `<span class="rounded-full border border-white/20 px-3 py-1">${tag} &bull; ${count}</span>`).join('');
      }
    }

    function renderMoods() {
      const total = Object.values(moodCounts).reduce((acc, val) => acc + val, 0) || 1;
      moodGrid.innerHTML = MOODS.map(m => {
        const count = moodCounts[m.id];
        const pct = Math.round((count / total) * 100);
        return `
          <div class="rounded-2xl border border-white/10 bg-white/5 p-4">
            <div class="flex items-center justify-between text-sm text-white/70">
              <span class="font-semibold text-white">${m.label}</span>
              <span>${count}</span>
            </div>
            <div class="mt-2 h-2 w-full overflow-hidden rounded-full bg-white/10">
              <div class="h-full rounded-full bg-gradient-to-r from-btyRed via-btyYellow to-white" style="width:${pct}%"></div>
            </div>
            <p class="mt-2 text-xs uppercase tracking-[0.2em] text-white/50">${pct}%</p>
          </div>`;
      }).join('');
    }

    function renderPersonas(personaCounts) {
      const counts = personaCounts || stageState.personaCounts;
      const total = Object.values(counts).reduce((acc, val) => acc + val, 0) || 1;
      personaGrid.innerHTML = Object.entries(PERSONAS).map(([id, meta]) => {
        const count = counts[id] || 0;
        const pct = Math.round((count / total) * 100);
        return `
          <div class="rounded-2xl border border-white/10 bg-white/5 p-4">
            <div class="flex items-center justify-between text-sm text-white/70">
              <span class="font-semibold text-white">${meta.label}</span>
              <span>${count}</span>
            </div>
            <p class="mt-1 text-xs text-white/60">${meta.tie}</p>
            <div class="mt-3 h-2 w-full overflow-hidden rounded-full bg-white/10">
              <div class="h-full rounded-full bg-gradient-to-r from-btyBlue via-btyYellow to-btyRed" style="width:${pct}%"></div>
            </div>
            <p class="mt-2 text-xs uppercase tracking-[0.2em] text-white/50">${pct}% of room</p>
          </div>`;
      }).join('');
      renderTracks();
      renderRecommendations();
    }

    function renderTracks() {
      if (!trackGrid) return;
      const order = Object.entries(stageState.personaCounts)
        .sort((a,b)=>b[1]-a[1])
        .map(([id]) => id);
      trackGrid.innerHTML = TRACKS.map(track => {
        const emphasise = order[0] === track.persona;
        return `
          <div class="group relative overflow-hidden rounded-3xl border border-white/10 bg-white/5">
            <img src="${track.image}" alt="${track.title}" class="h-48 w-full object-cover opacity-60 transition duration-500 group-hover:opacity-90" />
            <div class="absolute inset-0 bg-gradient-to-br from-black/70 via-black/40 to-transparent"></div>
            <div class="relative flex h-full flex-col justify-end gap-3 p-6">
              <p class="text-xs uppercase tracking-[0.3em] ${emphasise ? 'text-btyYellow' : 'text-white/60'}">${track.subtitle}</p>
              <h3 class="text-2xl font-bold text-white">${track.title}</h3>
              <p class="text-sm text-white/70">${track.description}</p>
            </div>
          </div>`;
      }).join('');
    }

    function renderRecommendations() {
      if (!recommendGrid) return;
      const counts = stageState.personaCounts || {};
      const order = Object.entries({ creator:0, guardian:0, explorer:0, trailblazer:0 })
        .map(([k]) => [k, counts[k] || 0])
        .sort((a,b)=>b[1]-a[1])
        .map(([k]) => k);
      const cards = [
        { key:'creator', title:'Design studios', line:'ALP projects with AI, data and design thinking', tag:'Creator' },
        { key:'guardian', title:'Leadership houses', line:'SHARP, KP challenge, mentoring juniors', tag:'Guardian' },
        { key:'explorer', title:'Global classrooms', line:'NEXUS Sec 3 experiences &mdash; Bali, New Zealand, Korea, Japan', tag:'Explorer' },
        { key:'trailblazer', title:'Industry immersions', line:'Rockwell engineering, A*STAR labs, media with Berita Harian &amp; Tamil Murasu', tag:'Trailblazer' }
      ].sort((a,b)=> order.indexOf(a.key) - order.indexOf(b.key));
      recommendGrid.innerHTML = cards.map(card => `
        <div class="rounded-2xl border border-white/10 bg-white/5 p-4">
          <p class="text-xs uppercase tracking-[0.3em] text-btyYellow">${card.tag}</p>
          <h3 class="mt-2 text-xl font-semibold text-white">${card.title}</h3>
          <p class="mt-2 text-sm text-white/70">${card.line}</p>
        </div>`).join('');
    }

    function renderPoll(poll) {
      stageState.poll = poll || null;
      if (!poll) {
        pollQuestion.textContent = '';
        pollResults.innerHTML = '';
        revealBox.classList.add('hidden');
        return;
      }
      pollQuestion.textContent = poll.question || '';
      const total = (poll.options || []).reduce((acc,opt)=>acc + (opt.count || 0), 0) || 1;
      pollResults.innerHTML = (poll.options || []).map(opt => {
        const pct = Math.round(((opt.count || 0) / total) * 100);
        return `
          <div class="rounded-2xl border border-white/10 bg-white/5 p-4">
            <div class="flex items-center justify-between text-sm text-white/70">
              <span class="font-semibold text-white">${opt.label}</span>
              <span>${opt.count || 0}</span>
            </div>
            <div class="mt-2 h-2 w-full overflow-hidden rounded-full bg-white/10">
              <div class="h-full rounded-full bg-gradient-to-r from-btyRed via-btyYellow to-white" style="width:${pct}%"></div>
            </div>
            <p class="mt-2 text-xs uppercase tracking-[0.2em] text-white/50">${pct}%</p>
          </div>`;
      }).join('');
    }

    function renderSocial(featureId) {
      const posts = SOCIAL_POSTS;
      const active = featureId ? posts.find(p => p.id === featureId) : null;
      socialSource.textContent = active ? `Source: ${active.source}` : 'Source: Facebook • Beatty Official';
      socialGrid.innerHTML = posts.map(post => {
        const emphasis = featureId ? post.id === featureId : false;
        return `
          <article class="flex h-full flex-col gap-4 rounded-3xl border ${emphasis ? 'border-btyYellow/60 bg-btyYellow/10' : 'border-white/10 bg-white/5'} p-5">
            <img src="${post.image}" alt="${post.title}" class="h-40 w-full rounded-2xl object-cover" />
            <div class="flex flex-col gap-2">
              <h3 class="text-lg font-semibold text-white">${post.title}</h3>
              <p class="text-sm text-white/70">${post.copy}</p>
              <p class="text-xs text-white/40">${post.source}</p>
              ${post.link ? `<a href="${post.link}" target="_blank" rel="noopener" class="text-xs font-semibold text-btyYellow underline">View story</a>` : ''}
            </div>
          </article>`;
      }).join('');
    }

    function updateTimeline(timeline) {
      stageState.timeline = timeline || { active: false, label: 'Idle' };
      if (stageState.timeline.active) {
        badgeLabel.textContent = 'Auto flow running';
        badgeDot.classList.remove('bg-white/30');
        badgeDot.classList.add('bg-btyYellow');
      } else {
        badgeLabel.textContent = 'Flow idle';
        badgeDot.classList.remove('bg-btyYellow');
        badgeDot.classList.add('bg-white/30');
      }
      badgeText.textContent = stageState.timeline.label || (stageState.timeline.active ? 'In motion' : 'Ready for take-off.');
    }

    API.onEvent((type, data) => {
      if (type === 'init') {
        stageState.audience = data.audienceCounts || stageState.audience;
        stageState.interests = data.interests || stageState.interests;
        stageState.poll = data.poll || null;
        stageState.personaCounts = data.personaCounts || stageState.personaCounts;
        stageState.socialFeature = data.socialFeature || null;
        renderCounts();
        renderMoods();
        renderPersonas(stageState.personaCounts);
        renderPoll(stageState.poll);
        renderSocial(stageState.socialFeature);
        updateTimeline(data.timeline);
        setScene(data.scene || 'join');
      }

      if (type === 'scene') setScene(data.scene);

      if (type === 'join') {
        stageState.audience = data.audienceCounts || stageState.audience;
        stageState.interests = data.interests || stageState.interests;
        renderCounts();
      }

      if (type === 'poll:start' || type === 'poll:vote') {
        renderPoll(data);
        setScene('poll');
        revealBox.classList.add('hidden');
      }

      if (type === 'poll:stop') {
        renderPoll(null);
      }

      if (type === 'poll:reveal') {
        if (data?.options) {
          stageState.poll = {
            ...(stageState.poll || {}),
            options: data.options
          };
          renderPoll(stageState.poll);
        }
        revealText.textContent = data?.answerText || '';
        revealBox.classList.remove('hidden');
        revealBox.classList.add('ring-2', 'ring-btyYellow', 'bg-btyYellow/20');
        badgeText.textContent = data?.answerText ? `Answer revealed: ${data.answerText}` : 'Answer revealed';
        setTimeout(() => {
          revealBox.classList.remove('ring-2', 'ring-btyYellow', 'bg-btyYellow/20');
        }, 2000);
      }

      if (type === 'mood') {
        const id = data.id;
        if (Object.hasOwn(moodCounts, id)) {
          moodCounts[id] += 1;
          renderMoods();
        }
      }

      if (type === 'persona') {
        if (data.personaCounts) {
          stageState.personaCounts = data.personaCounts;
          renderPersonas(stageState.personaCounts);
        }
        if (data.id && PERSONAS[data.id]) {
          badgeText.textContent = `${PERSONAS[data.id].label} voices are coming through.`;
        }
      }

      if (type === 'timeline:status') {
        updateTimeline(data);
      }

      if (type === 'media:play') {
        mediaOverlay.classList.remove('hidden');
        mediaTitle.textContent = data.title || 'Media cue';
        mediaFrame.src = data.url || '';
      }

      if (type === 'media:stop') {
        mediaOverlay.classList.add('hidden');
        mediaFrame.src = '';
      }

      if (type === 'social:feature') {
        stageState.socialFeature = data?.id || null;
        renderSocial(stageState.socialFeature);
      }

      if (type === 'journey:summary') {
        badgeText.textContent = `Journey Cards saved: ${data?.count || 0}`;
      }

      if (type === 'ops:ping') {
        badgeText.textContent = `${data.note || 'Tech check'} - ${new Date(data.ts || Date.now()).toLocaleTimeString()}`;
      }

      if (!window.__qrRendered && window.QRCode) {
        new QRCode('qrcode', { text: `${window.location.origin}/passport`, width: 120, height: 120 });
        window.__qrRendered = true;
      }
    });
  </script>
</body>
</html>

